"use client";

import { useState, useMemo, useEffect, useRef } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle, CardFooter } from "@repo/ui/card";
import { Button } from "@repo/ui/button";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from '@repo/ui/dialog';
import { DropdownMenu, DropdownMenuTrigger, DropdownMenuContent, DropdownMenuItem } from '@repo/ui/dropdown-menu';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@repo/ui/select";
import { Pagination } from "@repo/ui/pagination";
import { Badge } from "@repo/ui/badge";
import { Download, Eye, DollarSign, Users, UserPlus, ShoppingCart, Search, Calendar, Copy, FileText, FileSpreadsheet, Printer, Filter } from 'lucide-react';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@repo/ui/table";
import { Input } from '@repo/ui/input';
import { Skeleton } from "@repo/ui/skeleton";
import { useCrmAuth } from '@/hooks/useCrmAuth';
import {
  useGetAllAppointmentsReportQuery,
  useGetSummaryByServiceReportQuery,
  useGetCompletedAppointmentsReportQuery,
  useGetCancelledAppointmentsReportQuery,
  useGetSalesByServiceReportQuery,
  useGetSalesByCustomerReportQuery,
  useGetProductSummaryReportQuery,
  useGetSalesByProductReportQuery,
  useGetInventoryStockReportQuery,
  useGetCategoryWiseProductReportQuery,
  useGetUniqueClientsQuery,
  useGetUniqueServicesQuery,
  useGetUniqueStaffQuery,
  useGetUniqueProductNamesQuery,
  useGetUniqueBrandsQuery,
  useGetUniqueCategoriesQuery,
  useGetSettlementSummaryReportQuery
} from '@repo/store/api';

// Export functionality imports
import * as XLSX from 'xlsx';
import jsPDF from 'jspdf';
import html2canvas from 'html2canvas';

import { ExportOptions } from '../shared/ExportOptions';
import { FilterModal } from '../shared/FilterModal';
import { Report, ReportCategory, FilterParams } from '../shared/types';
const reportsData: ReportCategory[] = [
  {
    category: "Sales Summary",
    reports: [
      {
        title: "Sales by Product",
        description: "Detailed report showing revenue generated by each product (only delivered products).",
        details: "Displays product ID, product name, brand, product category, quantity sold, gross sales, discount amount, net sales, tax amount, total sales, average selling price, cost of goods sold, gross profit, and gross margin %."
      }
    ]
  },
  {
    category: "Product Summary",
    reports: [
      {
        title: "All Products Report",
        description: "Complete record of all products with detailed information.",
        details: "Includes product name, category, price, sale price, stock quantity, status, and creation date."
      },
      {
        title: "Inventory / Stock Report",
        description: "Detailed analysis of product inventory and stock levels.",
        details: "Shows product name, current stock, low stock alerts, last updated date, and stock movement history."
      },
      {
        title: "Category-wise Product Report",
        description: "Aggregated view showing product counts and sales by category.",
        details: "Displays category name, total products, average price, total stock value, and sales performance metrics."
      }
    ]
  }
];



// Component to display All Appointments report data in a table
const AllAppointmentsTable = ({ startDate, endDate, client, service, staff, status, bookingType, onFiltersChange, triggerRefresh }: any) => {
  const [filters, setFilters] = useState<FilterParams>({});
  const [isFilterModalOpen, setIsFilterModalOpen] = useState(false);
  const [currentPage, setCurrentPage] = useState(1);
  const [itemsPerPage, setItemsPerPage] = useState(10); // 10 entries by default
  const [searchTerm, setSearchTerm] = useState('');
  const tableRef = useRef<HTMLDivElement>(null);

  // Use the RTK Query hook to fetch real data
  const { data, isLoading, isError, refetch } = useGetAllAppointmentsReportQuery({
    period: 'custom',
    startDate: startDate ? new Date(startDate) : undefined,
    endDate: endDate ? new Date(endDate) : undefined,
    client: client && client !== 'all' ? client : undefined,
    service: service && service !== 'all' ? service : undefined,
    staff: staff && staff !== 'all' ? staff : undefined,
    status: status && status !== 'all' ? status : undefined,
    bookingType: bookingType && bookingType !== 'all' ? bookingType : undefined
  });

  const handleFilterChange = (newFilters: FilterParams) => {
    setFilters(newFilters);
    setCurrentPage(1); // Reset to first page when filters change

    // Notify parent component about filter changes
    if (onFiltersChange) {
      onFiltersChange(newFilters);
    }
  };
  // Export functions
  const exportToExcel = () => {
    if (!tableRef.current) return;

    const table = tableRef.current.querySelector('table');
    if (!table) return;

    // Get table data
    const wb = XLSX.utils.table_to_book(table, { sheet: 'Appointments' });
    XLSX.writeFile(wb, 'all_appointments.xlsx');
  };

  const exportToCSV = () => {
    if (!tableRef.current) return;

    const table = tableRef.current.querySelector('table');
    if (!table) return;

    // Get table data
    const wb = XLSX.utils.table_to_book(table, { sheet: 'Appointments' });
    XLSX.writeFile(wb, 'all_appointments.csv');
  };

  const exportToPDF = async () => {
    if (!tableRef.current) return;

    // Use html2canvas to capture the table
    const canvas = await html2canvas(tableRef.current);
    const imgData = canvas.toDataURL('image/png');

    // Create PDF
    const pdf = new jsPDF();
    const imgWidth = pdf.internal.pageSize.getWidth();
    const imgHeight = (canvas.height * imgWidth) / canvas.width;

    pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
    pdf.save('all_appointments.pdf');
  };

  const copyToClipboard = () => {
    if (!tableRef.current) return;

    const table = tableRef.current.querySelector('table');
    if (!table) return;

    // Get table HTML
    const range = document.createRange();
    range.selectNode(table);
    window.getSelection()?.removeAllRanges();
    window.getSelection()?.addRange(range);
    document.execCommand('copy');
    window.getSelection()?.removeAllRanges();

    // Show success message (you might want to implement a toast notification)
    alert('Table copied to clipboard!');
  };

  const printTable = () => {
    if (!tableRef.current) return;

    const printWindow = window.open('', '', 'height=600,width=800');
    if (printWindow) {
      printWindow.document.write('<html><head><title>All Appointments</title>');
      printWindow.document.write('</head><body >');
      printWindow.document.write(tableRef.current.innerHTML);
      printWindow.document.write('</body></html>');
      printWindow.document.close();
      printWindow.print();
    }
  };

  const handleExport = (format: string) => {
    switch (format) {
      case 'excel':
        exportToExcel();
        break;
      case 'csv':
        exportToCSV();
        break;
      case 'pdf':
        exportToPDF();
        break;
      case 'copy':
        copyToClipboard();
        break;
      case 'print':
        printTable();
        break;
      default:
        break;
    }
  };

  // Trigger refetch when filter values change or when explicitly triggered
  useEffect(() => {
    refetch();
  }, [refetch, startDate, endDate, client, service, staff, status, bookingType, triggerRefresh]);

  // Extract appointments from the API response
  const filteredAppointments = data?.data?.allAppointments?.appointments || data?.data || [];
  const totalAppointments = data?.data?.allAppointments?.total || filteredAppointments.length || 0;

  // Filter data based on search term
  const searchedAppointments = useMemo(() => {
    if (!searchTerm) return filteredAppointments;

    return filteredAppointments.filter((appointment: any) =>
      Object.values(appointment).some(value =>
        value && value.toString().toLowerCase().includes(searchTerm.toLowerCase())
      )
    );
  }, [filteredAppointments, searchTerm]);

  // Pagination logic
  const totalItems = searchedAppointments.length;
  const totalPages = Math.ceil(totalItems / itemsPerPage);
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const paginatedAppointments = searchedAppointments.slice(startIndex, endIndex);

  // Calculate counts - using mode field
  // For accurate counts, we need to count unique appointments by ID since multi-service appointments
  // are displayed as separate entries for each service
  const onlineAppointmentIds = new Set();
  const offlineAppointmentIds = new Set();

  paginatedAppointments.forEach((appt: any) => {
    const mode = appt.mode || '';
    if (mode.toLowerCase() === 'online') {
      onlineAppointmentIds.add(appt.id);
    } else if (mode.toLowerCase() === 'offline') {
      offlineAppointmentIds.add(appt.id);
    }
  });

  const onlineAppointments = onlineAppointmentIds.size;
  const offlineAppointments = offlineAppointmentIds.size;

  if (isLoading) {
    return (
      <div>
        <div className="flex justify-between items-center mb-4 gap-2">
          <div className="relative w-64">
            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              type="search"
              placeholder="Search..."
              className="pl-8"
              value={searchTerm}
              onChange={(e) => {
                setSearchTerm(e.target.value);
                setCurrentPage(1); // Reset to first page when search term changes
              }}
            />
          </div>
          <div className="flex gap-2">
            <Button onClick={() => setIsFilterModalOpen(true)}>
              <Filter className="mr-2 h-4 w-4" />
              Filters
            </Button>
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button>
                  <Download className="mr-2 h-4 w-4" />
                  Export
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent align="end">
                <DropdownMenuItem onClick={() => handleExport('copy')}>
                  <Copy className="mr-2 h-4 w-4" />
                  Copy
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('excel')}>
                  <FileSpreadsheet className="mr-2 h-4 w-4" />
                  Excel
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('csv')}>
                  <FileText className="mr-2 h-4 w-4" />
                  CSV
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('pdf')}>
                  <FileText className="mr-2 h-4 w-4" />
                  PDF
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('print')}>
                  <Printer className="mr-2 h-4 w-4" />
                  Print
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          </div>
        </div>
        <div className="flex justify-center items-center h-32">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
        </div>
      </div>
    );
  }

  if (isError) {
    return (
      <div>
        <div className="flex justify-between items-center mb-4 gap-2">
          <div className="relative w-64">
            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              type="search"
              placeholder="Search..."
              className="pl-8"
              value={searchTerm}
              onChange={(e) => {
                setSearchTerm(e.target.value);
                setCurrentPage(1); // Reset to first page when search term changes
              }}
            />
          </div>
          <Button onClick={() => setIsFilterModalOpen(true)}>
            <Filter className="mr-2 h-4 w-4" />
            Filters
          </Button>
        </div>
        <div className="text-center py-4 text-red-500">
          Failed to load appointment data. Please try again.
        </div>
      </div>
    );
  }

  return (
    <div>
      <div className="flex justify-between items-center mb-4 gap-2">
        <div className="relative w-64">
          <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
          <Input
            type="search"
            placeholder="Search..."
            className="pl-8"
            value={searchTerm}
            onChange={(e) => {
              setSearchTerm(e.target.value);
              setCurrentPage(1); // Reset to first page when search term changes
            }}
          />
        </div>
        <div className="flex gap-2">
          <Button onClick={() => setIsFilterModalOpen(true)}>
            <Filter className="mr-2 h-4 w-4" />
            Filters
          </Button>
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button>
                <Download className="mr-2 h-4 w-4" />
                Export
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end">
              <DropdownMenuItem onClick={() => handleExport('copy')}>
                <Copy className="mr-2 h-4 w-4" />
                Copy
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('excel')}>
                <FileSpreadsheet className="mr-2 h-4 w-4" />
                Excel
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('csv')}>
                <FileText className="mr-2 h-4 w-4" />
                CSV
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('pdf')}>
                <FileText className="mr-2 h-4 w-4" />
                PDF
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('print')}>
                <Printer className="mr-2 h-4 w-4" />
                Print
              </DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
        </div>
      </div>

      <FilterModal
        isOpen={isFilterModalOpen}
        onClose={() => setIsFilterModalOpen(false)}
        onApplyFilters={handleFilterChange}
        cities={[]}
        initialFilters={filters}
        showStatusFilter={true}
      />


      {/* Summary Cards */}
      <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
        <div className="border rounded-lg p-4 bg-blue-50">
          <p className="text-sm text-gray-600">Total Bookings</p>
          <p className="text-2xl font-bold">{totalAppointments}</p>
        </div>
        <div className="border rounded-lg p-4 bg-green-50">
          <p className="text-sm text-gray-600">Online Bookings</p>
          <p className="text-2xl font-bold">{onlineAppointments}</p>
        </div>
        <div className="border rounded-lg p-4 bg-orange-50">
          <p className="text-sm text-gray-600">Offline Bookings</p>
          <p className="text-2xl font-bold">{offlineAppointments}</p>
        </div>
        <div className="border rounded-lg p-4 bg-purple-50">
          <p className="text-sm text-gray-600">Total Revenue</p>
          <p className="text-2xl font-bold">₹{
            // Calculate revenue only from completed appointments
            // For multi-service appointments, sum the base amounts of all services when completed
            paginatedAppointments
              .filter((appt: any) => (appt.status || '').toLowerCase() === 'completed')
              .reduce((sum: number, appt: any) => sum + (appt.amount || 0), 0)
          }</p>
        </div>
        <div className="border rounded-lg p-4 bg-cyan-50">
          <p className="text-sm text-gray-600">Total Business</p>
          <p className="text-2xl font-bold">₹{
            // Calculate total business for completed appointments using finalAmount
            // For multi-service appointments, count finalAmount only once per appointment
            Array.from(new Set(paginatedAppointments
              .filter((appt: any) => (appt.status || '').toLowerCase() === 'completed')
              .map((appt: any) => appt.id)))
              .reduce((sum: number, id: any) => {
                const appt = paginatedAppointments.find((a: any) => a.id === id && (a.status || '').toLowerCase() === 'completed');
                return sum + (appt?.finalAmount || appt?.totalAmount || 0);
              }, 0)
          }</p>
        </div>
      </div>

      {/* Appointment Count */}
      <div className="text-lg font-medium">
        Total appointments: {
          // Count unique appointments to properly handle multi-service appointments
          Array.from(new Set<string>(paginatedAppointments.map((appt: any) => appt.id))).length
        }
      </div>

      {/* Multi-service note */}
      <div className="text-sm text-gray-500 italic">
        * Multi-service appointments are shown individually for each service. Status with * indicates multi-service appointment.
      </div>

      {/* Appointments Table */}
      <div ref={tableRef} className="overflow-x-auto no-scrollbar rounded-md border">
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead>Client</TableHead>
              <TableHead>Service</TableHead>
              <TableHead>Staff</TableHead>
              <TableHead>Scheduled On</TableHead>
              <TableHead>Created On</TableHead>
              <TableHead>Time</TableHead>
              <TableHead>Duration</TableHead>
              <TableHead>Base Amount</TableHead>
              <TableHead>Platform Fee</TableHead>
              <TableHead>Service Tax</TableHead>
              <TableHead>Final Amount</TableHead>
              <TableHead>Status</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {paginatedAppointments.map((item: any, index: number) => {
              // For multi-service appointments, calculate proportional amounts based on base amount ratios
              // For single-service appointments, use the original amounts
              let proportionalPlatformFee = item.platformFee || 0;
              let proportionalServiceTax = item.serviceTax || 0;
              let proportionalFinalAmount = item.finalAmount || item.totalAmount || 0;

              if (item.isMultiService) {
                // Calculate ratio of current service base amount to total appointment amount
                const ratio = item.amount && item.totalAmount ? item.amount / item.totalAmount : 0;
                proportionalPlatformFee = (item.platformFee || 0) * ratio;
                proportionalServiceTax = (item.serviceTax || 0) * ratio;
                // Calculate final amount as base + proportional platform fee + proportional service tax
                proportionalFinalAmount = (item.amount || 0) + proportionalPlatformFee + proportionalServiceTax;
              }

              // For proportional distribution, show amounts for all services in multi-service appointments
              const showAmounts = true;

              // Format dates
              const scheduledDate = item.date ? new Date(item.date).toLocaleDateString('en-GB', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
              }) : 'N/A';

              const createdDate = item.createdAt ? new Date(item.createdAt).toLocaleDateString('en-GB', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
              }) : 'N/A';

              // Format time range
              const timeRange = item.startTime && item.endTime ?
                `${item.startTime} - ${item.endTime}` : 'N/A';

              // Format service name for multi-service appointments
              let serviceName = item.serviceName || item.service?.name || 'N/A';
              if (item.isMultiService && item.multiServiceTotal) {
                serviceName = `${serviceName}(${item.multiServiceIndex + 1}/${item.multiServiceTotal})`;
              }

              // Format status with asterisk for multi-service appointments
              const statusText = item.isMultiService ? `${item.status}*` : item.status || 'N/A';

              return (
                <TableRow key={`${item.id}-${item.multiServiceIndex || 0}`}>
                  <TableCell>{item.clientName || 'N/A'}</TableCell>
                  <TableCell>{serviceName}</TableCell>
                  <TableCell>{item.staffName || item.staff?.fullName || 'N/A'}</TableCell>
                  <TableCell>{scheduledDate}</TableCell>
                  <TableCell>{createdDate}</TableCell>
                  <TableCell>{timeRange}</TableCell>
                  <TableCell>{item.duration || item.totalDuration || 'N/A'} mins</TableCell>
                  <TableCell>₹{item.amount || 0}</TableCell>
                  <TableCell>{showAmounts ? `₹${proportionalPlatformFee.toFixed(2)}` : ''}</TableCell>
                  <TableCell>{showAmounts ? `₹${proportionalServiceTax.toFixed(2)}` : ''}</TableCell>
                  <TableCell>{showAmounts ? `₹${proportionalFinalAmount.toFixed(2)}` : ''}</TableCell>
                  <TableCell>
                    <span className={`px-2 py-1 rounded-full text-xs ${(item.status || '').toLowerCase() === 'completed' ? 'bg-green-100 text-green-800' :
                      (item.status || '').toLowerCase() === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                        (item.status || '').toLowerCase() === 'cancelled' ? 'bg-red-100 text-red-800' :
                          (item.status || '').toLowerCase() === 'confirmed' ? 'bg-blue-100 text-blue-800' :
                            (item.status || '').toLowerCase() === 'scheduled' ? 'bg-purple-100 text-purple-800' :
                              'bg-gray-100 text-gray-800'
                      }`}>
                      {statusText}
                    </span>
                  </TableCell>
                </TableRow>
              );
            })}

            {/* Total Row */}
            <TableRow className="font-bold bg-gray-50">
              <TableCell>Total</TableCell>
              <TableCell colSpan={6}></TableCell>
              <TableCell>
                ₹{paginatedAppointments.reduce((sum: number, item: any) => sum + (item.amount || 0), 0)}
              </TableCell>
              <TableCell>
                ₹{paginatedAppointments.reduce((sum: number, item: any) => {
                  // Calculate proportional platform fee for each item
                  let proportionalPlatformFee = item.platformFee || 0;
                  if (item.isMultiService) {
                    const ratio = item.amount && item.totalAmount ? item.amount / item.totalAmount : 0;
                    proportionalPlatformFee = (item.platformFee || 0) * ratio;
                  }

                  return sum + proportionalPlatformFee;
                }, 0).toFixed(2)}
              </TableCell>
              <TableCell>
                ₹{paginatedAppointments.reduce((sum: number, item: any) => {
                  // Calculate proportional service tax for each item
                  let proportionalServiceTax = item.serviceTax || 0;
                  if (item.isMultiService) {
                    const ratio = item.amount && item.totalAmount ? item.amount / item.totalAmount : 0;
                    proportionalServiceTax = (item.serviceTax || 0) * ratio;
                  }

                  return sum + proportionalServiceTax;
                }, 0).toFixed(2)}
              </TableCell>
              <TableCell>
                ₹{paginatedAppointments.reduce((sum: number, item: any) => {
                  // Calculate proportional final amount for each item
                  let proportionalFinalAmount = item.finalAmount || item.totalAmount || 0;
                  if (item.isMultiService) {
                    const ratio = item.amount && item.totalAmount ? item.amount / item.totalAmount : 0;
                    const proportionalPlatformFee = (item.platformFee || 0) * ratio;
                    const proportionalServiceTax = (item.serviceTax || 0) * ratio;
                    proportionalFinalAmount = (item.amount || 0) + proportionalPlatformFee + proportionalServiceTax;
                  }

                  return sum + proportionalFinalAmount;
                }, 0).toFixed(2)}
              </TableCell>
              <TableCell></TableCell>
            </TableRow>
          </TableBody>
        </Table>
      </div>
      <Pagination
        className="mt-4"
        currentPage={currentPage}
        totalPages={totalPages}
        onPageChange={setCurrentPage}
        itemsPerPage={itemsPerPage}
        onItemsPerPageChange={setItemsPerPage}
        totalItems={totalItems}
      />
    </div>
  );
};

// Component to display Summary by Service report data in a table
const SummaryByServiceTable = ({ startDate, endDate, client, service, staff, status, bookingType, onFiltersChange, triggerRefresh }: any) => {
  const [filters, setFilters] = useState<FilterParams>({});
  const [isFilterModalOpen, setIsFilterModalOpen] = useState(false);
  const [currentPage, setCurrentPage] = useState(1);
  const [itemsPerPage, setItemsPerPage] = useState(10); // 10 entries by default
  const [searchTerm, setSearchTerm] = useState('');
  const tableRef = useRef<HTMLDivElement>(null);

  // Use the RTK Query hook to fetch real data
  const { data, isLoading, isError, refetch } = useGetSummaryByServiceReportQuery({
    period: 'custom',
    startDate: startDate ? new Date(startDate) : undefined,
    endDate: endDate ? new Date(endDate) : undefined,
    client: client && client !== 'all' ? client : undefined,
    service: service && service !== 'all' ? service : undefined,
    staff: staff && staff !== 'all' ? staff : undefined,
    status: status && status !== 'all' ? status : undefined,
    bookingType: bookingType && bookingType !== 'all' ? bookingType : undefined
  });

  const handleFilterChange = (newFilters: FilterParams) => {
    setFilters(newFilters);
    setCurrentPage(1); // Reset to first page when filters change

    // Notify parent component about filter changes
    if (onFiltersChange) {
      onFiltersChange(newFilters);
    }
  };

  // Export functions
  const exportToExcel = () => {
    if (!tableRef.current) return;

    const table = tableRef.current.querySelector('table');
    if (!table) return;

    // Get table data
    const wb = XLSX.utils.table_to_book(table, { sheet: 'Service Summary' });
    XLSX.writeFile(wb, 'summary_by_service.xlsx');
  };

  const exportToCSV = () => {
    if (!tableRef.current) return;

    const table = tableRef.current.querySelector('table');
    if (!table) return;

    // Get table data
    const wb = XLSX.utils.table_to_book(table, { sheet: 'Service Summary' });
    XLSX.writeFile(wb, 'summary_by_service.csv');
  };

  const exportToPDF = async () => {
    if (!tableRef.current) return;

    // Use html2canvas to capture the table
    const canvas = await html2canvas(tableRef.current);
    const imgData = canvas.toDataURL('image/png');

    // Create PDF
    const pdf = new jsPDF();
    const imgWidth = pdf.internal.pageSize.getWidth();
    const imgHeight = (canvas.height * imgWidth) / canvas.width;

    pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
    pdf.save('summary_by_service.pdf');
  };

  const copyToClipboard = () => {
    if (!tableRef.current) return;

    const table = tableRef.current.querySelector('table');
    if (!table) return;

    // Get table HTML
    const range = document.createRange();
    range.selectNode(table);
    window.getSelection()?.removeAllRanges();
    window.getSelection()?.addRange(range);
    document.execCommand('copy');
    window.getSelection()?.removeAllRanges();

    // Show success message (you might want to implement a toast notification)
    alert('Table copied to clipboard!');
  };

  const printTable = () => {
    if (!tableRef.current) return;

    const printWindow = window.open('', '', 'height=600,width=800');
    if (printWindow) {
      printWindow.document.write('<html><head><title>Appointment Summary by Service</title>');
      printWindow.document.write('</head><body >');
      printWindow.document.write(tableRef.current.innerHTML);
      printWindow.document.write('</body></html>');
      printWindow.document.close();
      printWindow.print();
    }
  };

  const handleExport = (format: string) => {
    switch (format) {
      case 'excel':
        exportToExcel();
        break;
      case 'csv':
        exportToCSV();
        break;
      case 'pdf':
        exportToPDF();
        break;
      case 'copy':
        copyToClipboard();
        break;
      case 'print':
        printTable();
        break;
      default:
        break;
    }
  };

  // Trigger refetch when filter values change or when explicitly triggered
  useEffect(() => {
    refetch();
  }, [refetch, startDate, endDate, client, service, staff, status, bookingType, triggerRefresh]);

  // Extract services from the API response
  const services = data?.data?.summaryByService || data?.data || [];

  // Filter data based on search term
  const searchedServices = useMemo(() => {
    if (!searchTerm) return services;

    return services.filter((service: any) =>
      Object.values(service).some(value =>
        value && value.toString().toLowerCase().includes(searchTerm.toLowerCase())
      )
    );
  }, [services, searchTerm]);

  // Pagination logic
  const totalItems = searchedServices.length;
  const totalPages = Math.ceil(totalItems / itemsPerPage);
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const paginatedServices = searchedServices.slice(startIndex, endIndex);

  // Calculate total appointments for percentage calculation
  const totalAppointments = paginatedServices.reduce((sum: number, service: any) => sum + (service.count || service.appointmentCount || 0), 0);

  if (isLoading) {
    return (
      <div>
        <div className="flex justify-between items-center mb-4 gap-2">
          <div className="relative w-64">
            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              type="search"
              placeholder="Search..."
              className="pl-8"
              value={searchTerm}
              onChange={(e) => {
                setSearchTerm(e.target.value);
                setCurrentPage(1); // Reset to first page when search term changes
              }}
            />
          </div>
          <div className="flex gap-2">
            <Button onClick={() => setIsFilterModalOpen(true)}>
              <Filter className="mr-2 h-4 w-4" />
              Filters
            </Button>
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button>
                  <Download className="mr-2 h-4 w-4" />
                  Export
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent align="end">
                <DropdownMenuItem onClick={() => handleExport('copy')}>
                  <Copy className="mr-2 h-4 w-4" />
                  Copy
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('excel')}>
                  <FileSpreadsheet className="mr-2 h-4 w-4" />
                  Excel
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('csv')}>
                  <FileText className="mr-2 h-4 w-4" />
                  CSV
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('pdf')}>
                  <FileText className="mr-2 h-4 w-4" />
                  PDF
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('print')}>
                  <Printer className="mr-2 h-4 w-4" />
                  Print
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          </div>
        </div>
        <div className="flex justify-center items-center h-32">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
        </div>
      </div>
    );
  }

  if (isError) {
    return (
      <div>
        <div className="flex justify-between items-center mb-4 gap-2">
          <div className="relative w-64">
            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              type="search"
              placeholder="Search..."
              className="pl-8"
              value={searchTerm}
              onChange={(e) => {
                setSearchTerm(e.target.value);
                setCurrentPage(1); // Reset to first page when search term changes
              }}
            />
          </div>
          <Button onClick={() => setIsFilterModalOpen(true)}>
            <Filter className="mr-2 h-4 w-4" />
            Filters
          </Button>
        </div>
        <div className="text-center py-4 text-red-500">
          Failed to load service summary data. Please try again.
        </div>
      </div>
    );
  }

  if (paginatedServices.length === 0) {
    return (
      <div>
        <div className="flex justify-between items-center mb-4 gap-2">
          <div className="relative w-64">
            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              type="search"
              placeholder="Search..."
              className="pl-8"
              value={searchTerm}
              onChange={(e) => {
                setSearchTerm(e.target.value);
                setCurrentPage(1); // Reset to first page when search term changes
              }}
            />
          </div>
          <Button onClick={() => setIsFilterModalOpen(true)}>
            <Filter className="mr-2 h-4 w-4" />
            Filters
          </Button>
        </div>
        <div className="text-center py-4 text-gray-500">
          No sales by service data available.
        </div>
      </div>
    );
  }

  return (
    <div>
      <div className="flex justify-between items-center mb-4 gap-2">
        <div className="relative w-64">
          <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
          <Input
            type="search"
            placeholder="Search..."
            className="pl-8"
            value={searchTerm}
            onChange={(e) => {
              setSearchTerm(e.target.value);
              setCurrentPage(1); // Reset to first page when search term changes
            }}
          />
        </div>
        <div className="flex gap-2">
          <Button onClick={() => setIsFilterModalOpen(true)}>
            <Filter className="mr-2 h-4 w-4" />
            Filters
          </Button>
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button>
                <Download className="mr-2 h-4 w-4" />
                Export
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end">
              <DropdownMenuItem onClick={() => handleExport('copy')}>
                <Copy className="mr-2 h-4 w-4" />
                Copy
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('excel')}>
                <FileSpreadsheet className="mr-2 h-4 w-4" />
                Excel
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('csv')}>
                <FileText className="mr-2 h-4 w-4" />
                CSV
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('pdf')}>
                <FileText className="mr-2 h-4 w-4" />
                PDF
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('print')}>
                <Printer className="mr-2 h-4 w-4" />
                Print
              </DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
        </div>
      </div>

      <FilterModal
        isOpen={isFilterModalOpen}
        onClose={() => setIsFilterModalOpen(false)}
        onApplyFilters={handleFilterChange}
        cities={[]}
        initialFilters={filters}
      />

      <div ref={tableRef} className="overflow-x-auto no-scrollbar rounded-md border">
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead>Service</TableHead>
              <TableHead>Total Appointments</TableHead>
              <TableHead>Total Sale</TableHead>
              <TableHead>Total Duration</TableHead>
              <TableHead>Percentage</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {paginatedServices.map((item: any, index: number) => {
              const count = item.count || item.appointmentCount || 0;
              const revenue = item.totalAmount || item.revenue || 0;
              const duration = item.totalDuration || item.averageDuration || 0;
              const percentage = totalAppointments > 0 ? (count / totalAppointments) * 100 : 0;

              return (
                <TableRow key={index}>
                  <TableCell className="font-medium">{item.serviceName || 'Unknown Service'}</TableCell>
                  <TableCell>{count}</TableCell>
                  <TableCell>₹{typeof revenue === 'number' ? revenue.toFixed(2) : '0.00'}</TableCell>
                  <TableCell>{typeof duration === 'number' ? duration.toFixed(0) : 0} mins</TableCell>
                  <TableCell>
                    <div className="flex items-center">
                      <span className="mr-2">{percentage.toFixed(1)}%</span>
                      <div className="w-16 bg-gray-200 rounded-full h-2">
                        <div
                          className="bg-blue-600 h-2 rounded-full"
                          style={{ width: `${percentage}%` }}
                        ></div>
                      </div>
                    </div>
                  </TableCell>
                </TableRow>
              );
            })}
          </TableBody>
        </Table>
      </div>
      <Pagination
        className="mt-4"
        currentPage={currentPage}
        totalPages={totalPages}
        onPageChange={setCurrentPage}
        itemsPerPage={itemsPerPage}
        onItemsPerPageChange={setItemsPerPage}
        totalItems={totalItems}
      />
    </div>
  );
};
// Component to display Completed Appointments report data in a table
const CompletedAppointmentsTable = ({ startDate, endDate, client, service, staff, bookingType, onFiltersChange, triggerRefresh }: any) => {
  const [filters, setFilters] = useState<FilterParams>({});
  const [isFilterModalOpen, setIsFilterModalOpen] = useState(false);
  const [currentPage, setCurrentPage] = useState(1);
  const [itemsPerPage, setItemsPerPage] = useState(10); // 10 entries by default
  const [searchTerm, setSearchTerm] = useState('');
  const tableRef = useRef<HTMLDivElement>(null);

  // Use the RTK Query hook to fetch real data
  const { data, isLoading, isError, refetch } = useGetCompletedAppointmentsReportQuery({
    period: 'custom',
    startDate: startDate ? new Date(startDate) : undefined,
    endDate: endDate ? new Date(endDate) : undefined,
    client: client && client !== 'all' ? client : undefined,
    service: service && service !== 'all' ? service : undefined,
    staff: staff && staff !== 'all' ? staff : undefined,
    bookingType: bookingType && bookingType !== 'all' ? bookingType : undefined
  });

  const handleFilterChange = (newFilters: FilterParams) => {
    setFilters(newFilters);
    setCurrentPage(1); // Reset to first page when filters change

    // Notify parent component about filter changes
    if (onFiltersChange) {
      onFiltersChange(newFilters);
    }
  };

  // Export functions
  const exportToExcel = () => {
    if (!tableRef.current) return;

    const table = tableRef.current.querySelector('table');
    if (!table) return;

    // Get table data
    const wb = XLSX.utils.table_to_book(table, { sheet: 'Completed Appointments' });
    XLSX.writeFile(wb, 'completed_appointments.xlsx');
  };

  const exportToCSV = () => {
    if (!tableRef.current) return;

    const table = tableRef.current.querySelector('table');
    if (!table) return;

    // Get table data
    const wb = XLSX.utils.table_to_book(table, { sheet: 'Completed Appointments' });
    XLSX.writeFile(wb, 'completed_appointments.csv');
  };

  const exportToPDF = async () => {
    if (!tableRef.current) return;

    // Use html2canvas to capture the table
    const canvas = await html2canvas(tableRef.current);
    const imgData = canvas.toDataURL('image/png');

    // Create PDF
    const pdf = new jsPDF();
    const imgWidth = pdf.internal.pageSize.getWidth();
    const imgHeight = (canvas.height * imgWidth) / canvas.width;

    pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
    pdf.save('completed_appointments.pdf');
  };

  const copyToClipboard = () => {
    if (!tableRef.current) return;

    const table = tableRef.current.querySelector('table');
    if (!table) return;

    // Get table HTML
    const range = document.createRange();
    range.selectNode(table);
    window.getSelection()?.removeAllRanges();
    window.getSelection()?.addRange(range);
    document.execCommand('copy');
    window.getSelection()?.removeAllRanges();

    // Show success message (you might want to implement a toast notification)
    alert('Table copied to clipboard!');
  };

  const printTable = () => {
    if (!tableRef.current) return;

    const printWindow = window.open('', '', 'height=600,width=800');
    if (printWindow) {
      printWindow.document.write('<html><head><title>Completed Appointments</title>');
      printWindow.document.write('</head><body >');
      printWindow.document.write(tableRef.current.innerHTML);
      printWindow.document.write('</body></html>');
      printWindow.document.close();
      printWindow.print();
    }
  };

  const handleExport = (format: string) => {
    switch (format) {
      case 'excel':
        exportToExcel();
        break;
      case 'csv':
        exportToCSV();
        break;
      case 'pdf':
        exportToPDF();
        break;
      case 'copy':
        copyToClipboard();
        break;
      case 'print':
        printTable();
        break;
      default:
        break;
    }
  };

  // Trigger refetch when filter values change or when explicitly triggered
  useEffect(() => {
    refetch();
  }, [refetch, startDate, endDate, client, service, staff, bookingType, triggerRefresh]);

  // Extract appointments from the API response (already filtered by backend)
  const filteredAppointments = data?.data?.complete?.appointments || data?.data || [];

  // Filter data based on search term
  const searchedAppointments = useMemo(() => {
    if (!searchTerm) return filteredAppointments;

    return filteredAppointments.filter((appointment: any) =>
      Object.values(appointment).some(value =>
        value && value.toString().toLowerCase().includes(searchTerm.toLowerCase())
      )
    );
  }, [filteredAppointments, searchTerm]);

  // Pagination logic
  const totalItems = searchedAppointments.length;
  const totalPages = Math.ceil(totalItems / itemsPerPage);
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const paginatedAppointments = searchedAppointments.slice(startIndex, endIndex);

  if (isLoading) {
    return (
      <div>
        <div className="flex justify-between items-center mb-4 gap-2">
          <div className="relative w-64">
            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              type="search"
              placeholder="Search..."
              className="pl-8"
              value={searchTerm}
              onChange={(e) => {
                setSearchTerm(e.target.value);
                setCurrentPage(1); // Reset to first page when search term changes
              }}
            />
          </div>
          <div className="flex gap-2">
            <Button onClick={() => setIsFilterModalOpen(true)}>
              <Filter className="mr-2 h-4 w-4" />
              Filters
            </Button>
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button>
                  <Download className="mr-2 h-4 w-4" />
                  Export
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent align="end">
                <DropdownMenuItem onClick={() => handleExport('copy')}>
                  <Copy className="mr-2 h-4 w-4" />
                  Copy
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('excel')}>
                  <FileSpreadsheet className="mr-2 h-4 w-4" />
                  Excel
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('csv')}>
                  <FileText className="mr-2 h-4 w-4" />
                  CSV
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('pdf')}>
                  <FileText className="mr-2 h-4 w-4" />
                  PDF
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('print')}>
                  <Printer className="mr-2 h-4 w-4" />
                  Print
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          </div>
        </div>
        <div className="flex justify-center items-center h-32">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
        </div>
      </div>
    );
  }

  if (isError) {
    return (
      <div>
        <div className="flex justify-between items-center mb-4 gap-2">
          <div className="relative w-64">
            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              type="search"
              placeholder="Search..."
              className="pl-8"
              value={searchTerm}
              onChange={(e) => {
                setSearchTerm(e.target.value);
                setCurrentPage(1); // Reset to first page when search term changes
              }}
            />
          </div>
          <Button onClick={() => setIsFilterModalOpen(true)}>
            <Filter className="mr-2 h-4 w-4" />
            Filters
          </Button>
        </div>
        <div className="text-center py-4 text-red-500">
          Failed to load completed appointments data. Please try again.
        </div>
      </div>
    );
  }

  if (paginatedAppointments.length === 0) {
    return (
      <div>
        <div className="flex justify-between items-center mb-4 gap-2">
          <div className="relative w-64">
            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              type="search"
              placeholder="Search..."
              className="pl-8"
              value={searchTerm}
              onChange={(e) => {
                setSearchTerm(e.target.value);
                setCurrentPage(1); // Reset to first page when search term changes
              }}
            />
          </div>
          <Button onClick={() => setIsFilterModalOpen(true)}>
            <Filter className="mr-2 h-4 w-4" />
            Filters
          </Button>
        </div>
        <div className="text-center py-4 text-gray-500">
          No completed appointments data available.
        </div>
        <FilterModal
          isOpen={isFilterModalOpen}
          onClose={() => setIsFilterModalOpen(false)}
          onApplyFilters={handleFilterChange}
          cities={[]}
          initialFilters={filters}
          showStatusFilter={false}
          hideClientFilter={false}
          hideServiceFilter={false}
          hideStaffFilter={false}
          hideBookingTypeFilter={false}
        />
      </div>
    );
  }

  return (
    <div>
      <div className="flex justify-between items-center mb-4 gap-2">
        <div className="relative w-64">
          <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
          <Input
            type="search"
            placeholder="Search..."
            className="pl-8"
            value={searchTerm}
            onChange={(e) => {
              setSearchTerm(e.target.value);
              setCurrentPage(1); // Reset to first page when search term changes
            }}
          />
        </div>
        <div className="flex gap-2">
          <Button onClick={() => setIsFilterModalOpen(true)}>
            <Filter className="mr-2 h-4 w-4" />
            Filters
          </Button>
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button>
                <Download className="mr-2 h-4 w-4" />
                Export
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end">
              <DropdownMenuItem onClick={() => handleExport('copy')}>
                <Copy className="mr-2 h-4 w-4" />
                Copy
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('excel')}>
                <FileSpreadsheet className="mr-2 h-4 w-4" />
                Excel
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('csv')}>
                <FileText className="mr-2 h-4 w-4" />
                CSV
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('pdf')}>
                <FileText className="mr-2 h-4 w-4" />
                PDF
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('print')}>
                <Printer className="mr-2 h-4 w-4" />
                Print
              </DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
        </div>
      </div>

      <FilterModal
        isOpen={isFilterModalOpen}
        onClose={() => setIsFilterModalOpen(false)}
        onApplyFilters={handleFilterChange}
        cities={[]}
        initialFilters={filters}
        showStatusFilter={false}
        hideClientFilter={false}
        hideServiceFilter={false}
        hideStaffFilter={false}
        hideBookingTypeFilter={false}
      />

      {/* Summary Cards */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div className="border rounded-lg p-4 bg-blue-50">
          <p className="text-sm text-gray-600">Total Completed</p>
          <p className="text-2xl font-bold">{
            // Count unique appointments, treating multi-service appointments as one
            Array.from(new Set<string>(paginatedAppointments.map((appt: any) => appt._id || appt.id))).length
          }</p>
        </div>
        <div className="border rounded-lg p-4 bg-green-50">
          <p className="text-sm text-gray-600">Online Completed</p>
          <p className="text-2xl font-bold">{
            // Count unique online appointments
            Array.from(
              new Set<string>(
                paginatedAppointments
                  .filter((appt: any) => (appt.mode || '').toLowerCase() === 'online')
                  .map((appt: any) => appt._id || appt.id)
              )
            ).length
          }</p>
        </div>
        <div className="border rounded-lg p-4 bg-orange-50">
          <p className="text-sm text-gray-600">Offline Completed</p>
          <p className="text-2xl font-bold">{
            // Count unique offline appointments
            Array.from(
              new Set<string>(
                paginatedAppointments
                  .filter((appt: any) => (appt.mode || '').toLowerCase() === 'offline')
                  .map((appt: any) => appt._id || appt.id)
              )
            ).length
          }</p>
        </div>
        <div className="border rounded-lg p-4 bg-purple-50">
          <p className="text-sm text-gray-600">Total Revenue</p>
          <p className="text-2xl font-bold">₹{
            // Calculate revenue from all appointments (already filtered as completed)
            // For multi-service appointments, sum the base amounts of all services
            paginatedAppointments.reduce((sum: number, appt: any) => sum + (appt.amount || 0), 0)
          }</p>
        </div>
      </div>

      <div ref={tableRef} className="overflow-x-auto no-scrollbar rounded-md border">
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead>Client</TableHead>
              <TableHead>Service</TableHead>
              <TableHead>Staff</TableHead>
              <TableHead>Scheduled On</TableHead>
              <TableHead>Created On</TableHead>
              <TableHead>Time</TableHead>
              <TableHead>Duration</TableHead>
              <TableHead>Base Amount</TableHead>
              <TableHead>Platform Fee</TableHead>
              <TableHead>Service Tax</TableHead>
              <TableHead>Final Amount</TableHead>
              <TableHead>Status</TableHead>



            </TableRow>
          </TableHeader>
          <TableBody>
            {paginatedAppointments.map((item: any) => {
              // Format dates
              const scheduledDate = item.date ? new Date(item.date).toLocaleDateString('en-GB', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
              }) : 'N/A';

              const createdDate = item.createdAt ? new Date(item.createdAt).toLocaleDateString('en-GB', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
              }) : 'N/A';

              // Format time range
              const timeRange = item.startTime && item.endTime ?
                `${item.startTime} - ${item.endTime}` : 'N/A';

              // Format service name for multi-service appointments
              let serviceName = item.serviceName || item.service?.name || 'N/A';
              if (item.isMultiService && item.multiServiceTotal) {
                serviceName = `${serviceName}(${item.multiServiceIndex + 1}/${item.multiServiceTotal})`;
              }

              // Format status with asterisk for multi-service appointments
              const statusText = item.isMultiService ? `${item.status}*` : item.status || 'N/A';

              return (
                <TableRow key={`${item.id}-${item.multiServiceIndex || 0}`}>
                  <TableCell>{item.clientName || 'N/A'}</TableCell>
                  <TableCell>{serviceName}</TableCell>
                  <TableCell>{item.staffName || item.staff?.fullName || 'N/A'}</TableCell>
                  <TableCell>{scheduledDate}</TableCell>
                  <TableCell>{createdDate}</TableCell>
                  <TableCell>{timeRange}</TableCell>
                  <TableCell>{item.duration || item.totalDuration || 'N/A'} mins</TableCell>
                  <TableCell>₹{item.amount || 0}</TableCell>
                  <TableCell>₹{item.platformFee || 0}</TableCell>
                  <TableCell>₹{item.serviceTax || 0}</TableCell>
                  <TableCell>₹{item.finalAmount || item.totalAmount || 0}</TableCell>
                  <TableCell>
                    <span className={`px-2 py-1 rounded-full text-xs ${(item.status || '').toLowerCase() === 'completed' ? 'bg-green-100 text-green-800' :
                      (item.status || '').toLowerCase() === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                        (item.status || '').toLowerCase() === 'cancelled' ? 'bg-red-100 text-red-800' :
                          (item.status || '').toLowerCase() === 'confirmed' ? 'bg-blue-100 text-blue-800' :
                            (item.status || '').toLowerCase() === 'scheduled' ? 'bg-purple-100 text-purple-800' :
                              'bg-gray-100 text-gray-800'
                      }`}>
                      {statusText}
                    </span>
                  </TableCell>
                </TableRow>
              );
            })}
            {/* Total Row */}
            <TableRow className="font-bold bg-gray-50">
              <TableCell>Total</TableCell>
              <TableCell colSpan={6}></TableCell>
              <TableCell>
                ₹{paginatedAppointments.reduce((sum: number, item: any) => sum + (item.amount || 0), 0)}
              </TableCell>
              <TableCell>
                ₹{paginatedAppointments.reduce((sum: number, item: any) => sum + (item.platformFee || 0), 0)}
              </TableCell>
              <TableCell>
                ₹{paginatedAppointments.reduce((sum: number, item: any) => sum + (item.serviceTax || 0), 0)}
              </TableCell>
              <TableCell>
                ₹{paginatedAppointments.reduce((sum: number, item: any) => sum + (item.finalAmount || item.totalAmount || 0), 0)}
              </TableCell>
              <TableCell></TableCell>
            </TableRow>
          </TableBody>
        </Table>
      </div>
      <Pagination
        className="mt-4"
        currentPage={currentPage}
        totalPages={totalPages}
        onPageChange={setCurrentPage}
        itemsPerPage={itemsPerPage}
        onItemsPerPageChange={setItemsPerPage}
        totalItems={totalItems}
      />
    </div>
  );
};

// Component to display Cancelled Appointments report data in a table
const CancelledAppointmentsTable = ({ startDate, endDate, client, service, staff, status, bookingType, onFiltersChange, triggerRefresh }: any) => {
  const [filters, setFilters] = useState<FilterParams>({});
  const [isFilterModalOpen, setIsFilterModalOpen] = useState(false);
  const [currentPage, setCurrentPage] = useState(1);
  const [itemsPerPage, setItemsPerPage] = useState(10); // 10 entries by default
  const [searchTerm, setSearchTerm] = useState('');
  const tableRef = useRef<HTMLDivElement>(null);

  // Use the RTK Query hook to fetch real data
  const { data, isLoading, isError, refetch } = useGetCancelledAppointmentsReportQuery({
    period: 'custom',
    startDate: startDate ? new Date(startDate) : undefined,
    endDate: endDate ? new Date(endDate) : undefined,
    client: client && client !== 'all' ? client : undefined,
    service: service && service !== 'all' ? service : undefined,
    staff: staff && staff !== 'all' ? staff : undefined,
    status: status && status !== 'all' ? status : undefined,
    bookingType: bookingType && bookingType !== 'all' ? bookingType : undefined
  });

  const handleFilterChange = (newFilters: FilterParams) => {
    setFilters(newFilters);
    setCurrentPage(1); // Reset to first page when filters change

    // Notify parent component about filter changes
    if (onFiltersChange) {
      onFiltersChange(newFilters);
    }
  };

  // Export functions
  const exportToExcel = () => {
    if (!tableRef.current) return;

    const table = tableRef.current.querySelector('table');
    if (!table) return;

    // Get table data
    const wb = XLSX.utils.table_to_book(table, { sheet: 'Cancelled Appointments' });
    XLSX.writeFile(wb, 'cancelled_appointments.xlsx');
  };

  const exportToCSV = () => {
    if (!tableRef.current) return;

    const table = tableRef.current.querySelector('table');
    if (!table) return;

    // Get table data
    const wb = XLSX.utils.table_to_book(table, { sheet: 'Cancelled Appointments' });
    XLSX.writeFile(wb, 'cancelled_appointments.csv');
  };

  const exportToPDF = async () => {
    if (!tableRef.current) return;

    // Use html2canvas to capture the table
    const canvas = await html2canvas(tableRef.current);
    const imgData = canvas.toDataURL('image/png');

    // Create PDF
    const pdf = new jsPDF();
    const imgWidth = pdf.internal.pageSize.getWidth();
    const imgHeight = (canvas.height * imgWidth) / canvas.width;

    pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
    pdf.save('cancelled_appointments.pdf');
  };

  const copyToClipboard = () => {
    if (!tableRef.current) return;

    const table = tableRef.current.querySelector('table');
    if (!table) return;

    // Get table HTML
    const range = document.createRange();
    range.selectNode(table);
    window.getSelection()?.removeAllRanges();
    window.getSelection()?.addRange(range);
    document.execCommand('copy');
    window.getSelection()?.removeAllRanges();

    // Show success message (you might want to implement a toast notification)
    alert('Table copied to clipboard!');
  };

  const printTable = () => {
    if (!tableRef.current) return;

    const printWindow = window.open('', '', 'height=600,width=800');
    if (printWindow) {
      printWindow.document.write('<html><head><title>Cancelled Appointments</title>');
      printWindow.document.write('</head><body >');
      printWindow.document.write(tableRef.current.innerHTML);
      printWindow.document.write('</body></html>');
      printWindow.document.close();
      printWindow.print();
    }
  };

  const handleExport = (format: string) => {
    switch (format) {
      case 'excel':
        exportToExcel();
        break;
      case 'csv':
        exportToCSV();
        break;
      case 'pdf':
        exportToPDF();
        break;
      case 'copy':
        copyToClipboard();
        break;
      case 'print':
        printTable();
        break;
      default:
        break;
    }
  };

  // Trigger refetch when filter values change or when explicitly triggered
  useEffect(() => {
    refetch();
  }, [refetch, startDate, endDate, client, service, staff, status, bookingType, triggerRefresh]);

  // Extract appointments from the API response
  const filteredAppointments = data?.data?.cancellations?.cancellations || data?.data || [];

  // Filter data based on search term
  const searchedAppointments = useMemo(() => {
    if (!searchTerm) return filteredAppointments;

    return filteredAppointments.filter((appointment: any) =>
      Object.values(appointment).some(value =>
        value && value.toString().toLowerCase().includes(searchTerm.toLowerCase())
      )
    );
  }, [filteredAppointments, searchTerm]);

  // Pagination logic
  const totalItems = searchedAppointments.length;
  const totalPages = Math.ceil(totalItems / itemsPerPage);
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const paginatedAppointments = searchedAppointments.slice(startIndex, endIndex);

  // Calculate counts for online/offline appointments
  const onlineAppointmentIds = new Set();
  const offlineAppointmentIds = new Set();

  paginatedAppointments.forEach((appt: any) => {
    const mode = appt.mode || '';
    if (mode.toLowerCase() === 'online') {
      onlineAppointmentIds.add(appt.id);
    } else if (mode.toLowerCase() === 'offline') {
      offlineAppointmentIds.add(appt.id);
    }
  });

  // Count unique appointments to properly handle multi-service appointments
  const uniqueAppointmentIds = new Set(paginatedAppointments.map((appt: any) => appt.id));
  const totalCancelled = uniqueAppointmentIds.size;
  const onlineCancelled = onlineAppointmentIds.size;
  const offlineCancelled = offlineAppointmentIds.size;
  // Calculate revenue loss from unique appointments to avoid double counting
  // For cancelled appointments, we sum the base amounts of all services
  const totalRevenueLoss = Array.from(uniqueAppointmentIds as Set<string>).reduce((sum: number, id: string) => {
    const appointment = paginatedAppointments.find((appt: any) => appt.id === id);
    return sum + (appointment?.amount || 0);
  }, 0);

  if (isLoading) {
    return (
      <div>
        <div className="flex justify-between items-center mb-4 gap-2">
          <div className="relative w-64">
            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              type="search"
              placeholder="Search..."
              className="pl-8"
              value={searchTerm}
              onChange={(e) => {
                setSearchTerm(e.target.value);
                setCurrentPage(1); // Reset to first page when search term changes
              }}
            />
          </div>
          <div className="flex gap-2">
            <Button onClick={() => setIsFilterModalOpen(true)}>
              <Filter className="mr-2 h-4 w-4" />
              Filters
            </Button>
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button>
                  <Download className="mr-2 h-4 w-4" />
                  Export
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent align="end">
                <DropdownMenuItem onClick={() => handleExport('copy')}>
                  <Copy className="mr-2 h-4 w-4" />
                  Copy
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('excel')}>
                  <FileSpreadsheet className="mr-2 h-4 w-4" />
                  Excel
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('csv')}>
                  <FileText className="mr-2 h-4 w-4" />
                  CSV
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('pdf')}>
                  <FileText className="mr-2 h-4 w-4" />
                  PDF
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('print')}>
                  <Printer className="mr-2 h-4 w-4" />
                  Print
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          </div>
        </div>
        <div className="flex justify-center items-center h-32">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
        </div>
      </div>
    );
  }

  if (isError) {
    return (
      <div>
        <div className="flex justify-between items-center mb-4 gap-2">
          <div className="relative w-64">
            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              type="search"
              placeholder="Search..."
              className="pl-8"
              value={searchTerm}
              onChange={(e) => {
                setSearchTerm(e.target.value);
                setCurrentPage(1); // Reset to first page when search term changes
              }}
            />
          </div>
          <Button onClick={() => setIsFilterModalOpen(true)}>
            <Filter className="mr-2 h-4 w-4" />
            Filters
          </Button>
        </div>
        <div className="text-center py-4 text-red-500">
          Failed to load cancelled appointments data. Please try again.
        </div>
      </div>
    );
  }

  if (paginatedAppointments.length === 0) {
    return (
      <div>
        <div className="flex justify-between items-center mb-4 gap-2">
          <div className="relative w-64">
            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              type="search"
              placeholder="Search..."
              className="pl-8"
              value={searchTerm}
              onChange={(e) => {
                setSearchTerm(e.target.value);
                setCurrentPage(1); // Reset to first page when search term changes
              }}
            />
          </div>
          <Button onClick={() => setIsFilterModalOpen(true)}>
            <Filter className="mr-2 h-4 w-4" />
            Filters
          </Button>
        </div>
        <div className="text-center py-4 text-gray-500">
          No cancelled appointments data available.
        </div>
        <FilterModal
          isOpen={isFilterModalOpen}
          onClose={() => setIsFilterModalOpen(false)}
          onApplyFilters={handleFilterChange}
          cities={[]}
          initialFilters={filters}
          showStatusFilter={true}
          hideClientFilter={false}
          hideServiceFilter={false}
          hideStaffFilter={false}
          hideBookingTypeFilter={false}
        />
      </div>
    );
  }

  return (
    <div>
      <div className="flex justify-between items-center mb-4 gap-2">
        <div className="relative w-64">
          <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
          <Input
            type="search"
            placeholder="Search..."
            className="pl-8"
            value={searchTerm}
            onChange={(e) => {
              setSearchTerm(e.target.value);
              setCurrentPage(1); // Reset to first page when search term changes
            }}
          />
        </div>
        <div className="flex gap-2">
          <Button onClick={() => setIsFilterModalOpen(true)}>
            <Filter className="mr-2 h-4 w-4" />
            Filters
          </Button>
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button>
                <Download className="mr-2 h-4 w-4" />
                Export
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end">
              <DropdownMenuItem onClick={() => handleExport('copy')}>
                <Copy className="mr-2 h-4 w-4" />
                Copy
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('excel')}>
                <FileSpreadsheet className="mr-2 h-4 w-4" />
                Excel
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('csv')}>
                <FileText className="mr-2 h-4 w-4" />
                CSV
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('pdf')}>
                <FileText className="mr-2 h-4 w-4" />
                PDF
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('print')}>
                <Printer className="mr-2 h-4 w-4" />
                Print
              </DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
        </div>
      </div>

      <FilterModal
        isOpen={isFilterModalOpen}
        onClose={() => setIsFilterModalOpen(false)}
        onApplyFilters={handleFilterChange}
        cities={[]}
        initialFilters={filters}
      />

      {/* Summary Cards */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div className="border rounded-lg p-4 bg-blue-50">
          <p className="text-sm text-gray-600">Total Cancelled</p>
          <p className="text-2xl font-bold">{totalCancelled}</p>
        </div>
        <div className="border rounded-lg p-4 bg-green-50">
          <p className="text-sm text-gray-600">Online Cancelled</p>
          <p className="text-2xl font-bold">{onlineCancelled}</p>
        </div>
        <div className="border rounded-lg p-4 bg-orange-50">
          <p className="text-sm text-gray-600">Offline Cancelled</p>
          <p className="text-2xl font-bold">{offlineCancelled}</p>
        </div>
        <div className="border rounded-lg p-4 bg-purple-50">
          <p className="text-sm text-gray-600">Revenue Loss</p>
          <p className="text-2xl font-bold">₹{totalRevenueLoss.toFixed(2)}</p>
        </div>
      </div>

      <div ref={tableRef} className="overflow-x-auto no-scrollbar rounded-md border">
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead>Client</TableHead>
              <TableHead>Service</TableHead>
              <TableHead>Staff</TableHead>
              <TableHead>Scheduled On</TableHead>
              <TableHead>Created On</TableHead>
              <TableHead>Time</TableHead>
              <TableHead>Cancelled By</TableHead>
              <TableHead>Cancelled On</TableHead>
              <TableHead>Base Amount</TableHead>
              <TableHead>Platform Fee</TableHead>
              <TableHead>Service Tax</TableHead>
              <TableHead>Final Amount</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {paginatedAppointments.map((item: any) => {
              // Helper function to convert MongoDB date objects to JavaScript Date
              const convertToDate = (dateValue: any): Date | null => {
                if (!dateValue) return null;

                if (dateValue instanceof Date) {
                  return dateValue;
                }

                // Check if it's a MongoDB date object format: {"$date": "..."}
                if (typeof dateValue === 'object' && dateValue.$date) {
                  return new Date(dateValue.$date);
                }

                // Check if it's already an ISO string
                if (typeof dateValue === 'string') {
                  return new Date(dateValue);
                }

                // If it's a timestamp number
                if (typeof dateValue === 'number') {
                  return new Date(dateValue);
                }

                return null;
              };

              // Format dates
              const scheduledDateValue = convertToDate(item.scheduledDate);
              const scheduledDate = scheduledDateValue ? scheduledDateValue.toLocaleDateString('en-GB', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
              }) : 'N/A';

              const createdDateValue = convertToDate(item.createdAt);
              const createdDate = createdDateValue ? createdDateValue.toLocaleDateString('en-GB', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
              }) : 'N/A';

              // Format time range
              const timeRange = item.startTime ?
                `${item.startTime} - ${item.endTime || item.startTime}` : 'N/A';

              // Format cancellation information
              const cancelledOnValue = convertToDate(item.cancelledDate);
              const cancelledOn = cancelledOnValue ? cancelledOnValue.toLocaleDateString('en-GB', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
              }) : 'N/A';

              // Determine who cancelled the appointment based on reason
              let cancelledBy = 'N/A';
              if (item.reason && item.reason.toLowerCase().includes('automatically cancelled')) {
                cancelledBy = 'Not Attended';
              } else if (item.mode === 'online' && item.clientName) {
                cancelledBy = 'User';
              } else {
                cancelledBy = 'Vendor';
              }

              // Format service name for multi-service appointments
              let serviceName = item.serviceName || item.service?.name || 'N/A';
              if (item.isMultiService && item.multiServiceTotal) {
                serviceName = `${serviceName}(${item.multiServiceIndex + 1}/${item.multiServiceTotal})`;
              }

              // Format status with asterisk for multi-service appointments
              const statusText = item.isMultiService ? `${item.status}*` : item.status || 'N/A';

              return (
                <TableRow key={`${item.id}-${item.multiServiceIndex || 0}`}>
                  <TableCell>{item.clientName || 'N/A'}</TableCell>
                  <TableCell>{serviceName}</TableCell>
                  <TableCell>{item.staffName || item.staff?.fullName || 'N/A'}</TableCell>
                  <TableCell>{scheduledDate}</TableCell>
                  <TableCell>{createdDate}</TableCell>
                  <TableCell>{timeRange}</TableCell>
                  <TableCell>{cancelledBy}</TableCell>
                  <TableCell>{cancelledOn}</TableCell>
                  <TableCell>₹{item.amount || 0}</TableCell>
                  <TableCell>₹{item.platformFee || 0}</TableCell>
                  <TableCell>₹{item.serviceTax || 0}</TableCell>
                  <TableCell>₹{item.finalAmount || item.totalAmount || 0}</TableCell>
                </TableRow>
              );
            })}
            {/* Total Row */}
            <TableRow className="font-bold bg-gray-50">
              <TableCell>Total</TableCell>
              <TableCell colSpan={7}></TableCell>
              <TableCell>
                ₹{paginatedAppointments.reduce((sum: number, item: any) => sum + (item.amount || 0), 0).toFixed(2)}
              </TableCell>
              <TableCell>
                ₹{paginatedAppointments.reduce((sum: number, item: any) => sum + (item.platformFee || 0), 0).toFixed(2)}
              </TableCell>
              <TableCell>
                ₹{paginatedAppointments.reduce((sum: number, item: any) => sum + (item.serviceTax || 0), 0).toFixed(2)}
              </TableCell>
              <TableCell>
                ₹{paginatedAppointments.reduce((sum: number, item: any) => sum + (item.finalAmount || item.totalAmount || 0), 0).toFixed(2)}
              </TableCell>
            </TableRow>
          </TableBody>
        </Table>
      </div>
      <Pagination
        className="mt-4"
        currentPage={currentPage}
        totalPages={totalPages}
        onPageChange={setCurrentPage}
        itemsPerPage={itemsPerPage}
        onItemsPerPageChange={setItemsPerPage}
        totalItems={totalItems}
      />
    </div>
  );
};

// Component to display All Appointments by Staff report data in a table
const AllAppointmentsByStaffTable = ({ startDate, endDate, client, service, staff, status, bookingType, onFiltersChange, triggerRefresh }: any) => {
  const [filters, setFilters] = useState<FilterParams>({});
  const [isFilterModalOpen, setIsFilterModalOpen] = useState(false);
  const [currentPage, setCurrentPage] = useState(1);
  const [itemsPerPage, setItemsPerPage] = useState(10); // 10 entries by default
  const [searchTerm, setSearchTerm] = useState('');
  const tableRef = useRef<HTMLDivElement>(null);

  // Use the RTK Query hook to fetch real data
  const { data, isLoading, isError, refetch } = useGetAllAppointmentsReportQuery({
    period: startDate && endDate ? 'custom' : 'all',
    startDate: startDate ? new Date(startDate) : undefined,
    endDate: endDate ? new Date(endDate) : undefined,
    client: client && client !== 'all' ? client : undefined,
    service: service && service !== 'all' ? service : undefined,
    staff: staff && staff !== 'all' ? staff : undefined,
    status: status && status !== 'all' ? status : undefined,
    bookingType: bookingType && bookingType !== 'all' ? bookingType : undefined
  });

  const handleFilterChange = (newFilters: FilterParams) => {
    setFilters(newFilters);
    setCurrentPage(1); // Reset to first page when filters change

    // Notify parent component about filter changes
    if (onFiltersChange) {
      onFiltersChange(newFilters);
    }
  };

  // Export functions
  const handleExport = (format: string) => {
    switch (format) {
      case 'excel':
        exportToExcel(tableRef, 'all_appointments_by_staff');
        break;
      case 'csv':
        exportToCSV(tableRef, 'all_appointments_by_staff');
        break;
      case 'pdf':
        exportToPDF(tableRef, 'all_appointments_by_staff');
        break;
      case 'copy':
        copyToClipboard(tableRef);
        break;
      case 'print':
        printTable(tableRef);
        break;
      default:
        break;
    }
  };

  // Trigger refetch when filter values change or when explicitly triggered
  useEffect(() => {
    refetch();
  }, [refetch, startDate, endDate, client, service, staff, status, bookingType, triggerRefresh]);

  // Aggregate appointments by staff
  const staffSummary = useMemo(() => {
    // Check if data exists and has the expected structure
    if (!data || !data.data || !data.data.allAppointments || !Array.isArray(data.data.allAppointments.appointments)) return [];

    // Create a map to store staff data
    const staffMap = new Map();

    // Process each appointment
    data.data.allAppointments.appointments.forEach((appointment: any) => {
      const staffName = appointment.staffName || 'Unassigned';

      // Get or create staff entry
      if (!staffMap.has(staffName)) {
        staffMap.set(staffName, {
          staffName,
          totalAppointments: 0,
          totalDuration: 0,
          totalSale: 0
        });
      }

      const staffEntry = staffMap.get(staffName);

      // Increment appointment count
      staffEntry.totalAppointments += 1;

      // Add duration (in minutes)
      if (appointment.duration) {
        staffEntry.totalDuration += appointment.duration;
      }

      // Add sale amount (use finalAmount if available, otherwise totalAmount, otherwise amount)
      const saleAmount = appointment.finalAmount || appointment.totalAmount || appointment.amount || 0;
      staffEntry.totalSale += saleAmount;
    });

    // Convert map to array
    return Array.from(staffMap.values());
  }, [data]);

  // Filter data based on search term
  const searchedStaff = useMemo(() => {
    if (!searchTerm) return staffSummary;

    return staffSummary.filter((staff: any) =>
      staff.staffName.toLowerCase().includes(searchTerm.toLowerCase())
    );
  }, [staffSummary, searchTerm]);

  // Pagination logic
  const totalItems = searchedStaff.length;
  const totalPages = Math.ceil(totalItems / itemsPerPage);
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const paginatedStaff = searchedStaff.slice(startIndex, endIndex);

  if (isLoading) {
    return (
      <div>
        <div className="flex justify-between items-center mb-4 gap-2">
          <div className="relative w-64">
            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              type="search"
              placeholder="Search staff..."
              className="pl-8"
              value={searchTerm}
              onChange={(e) => {
                setSearchTerm(e.target.value);
                setCurrentPage(1); // Reset to first page when search term changes
              }}
            />
          </div>
          <div className="flex gap-2">
            <Button onClick={() => setIsFilterModalOpen(true)}>
              <Filter className="mr-2 h-4 w-4" />
              Filters
            </Button>
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button>
                  <Download className="mr-2 h-4 w-4" />
                  Export
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent align="end">
                <DropdownMenuItem onClick={() => handleExport('copy')}>
                  <Copy className="mr-2 h-4 w-4" />
                  Copy
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('excel')}>
                  <FileSpreadsheet className="mr-2 h-4 w-4" />
                  Excel
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('csv')}>
                  <FileText className="mr-2 h-4 w-4" />
                  CSV
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('pdf')}>
                  <FileText className="mr-2 h-4 w-4" />
                  PDF
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('print')}>
                  <Printer className="mr-2 h-4 w-4" />
                  Print
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          </div>
        </div>
        <div className="rounded-md border">
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>Staff Name</TableHead>
                <TableHead>Total Appointments</TableHead>
                <TableHead>Total Duration</TableHead>
                <TableHead>Total Sale</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {[...Array(5)].map((_, index) => (
                <TableRow key={index}>
                  <TableCell>
                    <Skeleton className="h-4 w-32" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-16" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-20" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-20" />
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </div>
      </div>
    );
  }

  if (isError) {
    return (
      <div>
        <div className="flex justify-between items-center mb-4 gap-2">
          <div className="relative w-64">
            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              type="search"
              placeholder="Search staff..."
              className="pl-8"
              value={searchTerm}
              onChange={(e) => {
                setSearchTerm(e.target.value);
                setCurrentPage(1); // Reset to first page when search term changes
              }}
            />
          </div>
          <div className="flex gap-2">
            <Button onClick={() => setIsFilterModalOpen(true)}>
              <Filter className="mr-2 h-4 w-4" />
              Filters
            </Button>
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button>
                  <Download className="mr-2 h-4 w-4" />
                  Export
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent align="end">
                <DropdownMenuItem onClick={() => handleExport('copy')}>
                  <Copy className="mr-2 h-4 w-4" />
                  Copy
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('excel')}>
                  <FileSpreadsheet className="mr-2 h-4 w-4" />
                  Excel
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('csv')}>
                  <FileText className="mr-2 h-4 w-4" />
                  CSV
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('pdf')}>
                  <Printer className="mr-2 h-4 w-4" />
                  PDF
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('print')}>
                  <Printer className="mr-2 h-4 w-4" />
                  Print
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          </div>
        </div>
        <div className="text-center py-10">
          <div className="text-red-500 font-semibold">Error loading data</div>
          <Button onClick={() => refetch()} className="mt-4">Retry</Button>
        </div>
        <FilterModal
          isOpen={isFilterModalOpen}
          onClose={() => setIsFilterModalOpen(false)}
          onApplyFilters={handleFilterChange}
          cities={[]}
          initialFilters={filters}
          showStatusFilter={true}
        />
      </div>
    );
  }

  return (
    <div ref={tableRef}>
      <div className="flex justify-between items-center mb-4 gap-2">
        <div className="relative w-64">
          <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
          <Input
            type="search"
            placeholder="Search staff..."
            className="pl-8"
            value={searchTerm}
            onChange={(e) => {
              setSearchTerm(e.target.value);
              setCurrentPage(1); // Reset to first page when search term changes
            }}
          />
        </div>
        <div className="flex gap-2">
          <Button onClick={() => setIsFilterModalOpen(true)}>
            <Filter className="mr-2 h-4 w-4" />
            Filters
          </Button>
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button>
                <Download className="mr-2 h-4 w-4" />
                Export
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end">
              <DropdownMenuItem onClick={() => handleExport('copy')}>
                <Copy className="mr-2 h-4 w-4" />
                Copy
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('excel')}>
                <FileSpreadsheet className="mr-2 h-4 w-4" />
                Excel
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('csv')}>
                <FileText className="mr-2 h-4 w-4" />
                CSV
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('pdf')}>
                <FileText className="mr-2 h-4 w-4" />
                PDF
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('print')}>
                <Printer className="mr-2 h-4 w-4" />
                Print
              </DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
        </div>
      </div>
      <div className="rounded-md border">
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead>Staff Name</TableHead>
              <TableHead>Total Appointments</TableHead>
              <TableHead>Total Duration</TableHead>
              <TableHead>Total Sale</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {paginatedStaff.length > 0 ? (
              paginatedStaff.map((staff: any, index: number) => (
                <TableRow key={`${staff.staffName}-${index}`}>
                  <TableCell className="font-medium">{staff.staffName}</TableCell>
                  <TableCell>{staff.totalAppointments}</TableCell>
                  <TableCell>
                    {/* Convert minutes to hours and minutes */}
                    {staff.totalDuration >= 60
                      ? `${Math.floor(staff.totalDuration / 60)} hr ${staff.totalDuration % 60} min`
                      : `${staff.totalDuration} min`}
                  </TableCell>
                  <TableCell>₹{staff.totalSale.toFixed(2)}</TableCell>
                </TableRow>
              ))
            ) : (
              <TableRow>
                <TableCell colSpan={4} className="text-center py-8 text-muted-foreground">
                  No appointments by staff data available.
                </TableCell>
              </TableRow>
            )}
          </TableBody>
        </Table>
      </div>
      <Pagination
        className="mt-4"
        currentPage={currentPage}
        totalPages={totalPages}
        onPageChange={setCurrentPage}
        itemsPerPage={itemsPerPage}
        onItemsPerPageChange={setItemsPerPage}
        totalItems={totalItems}
      />
      <FilterModal
        isOpen={isFilterModalOpen}
        onClose={() => setIsFilterModalOpen(false)}
        onApplyFilters={handleFilterChange}
        cities={[]}
        initialFilters={filters}
        showStatusFilter={true}
      />
    </div>
  );
};

// Export functionality functions
const exportToExcel = (tableRef: React.RefObject<HTMLDivElement>, fileName: string) => {
  if (!tableRef.current) return;

  const table = tableRef.current.querySelector('table');
  if (!table) return;

  const wb = XLSX.utils.table_to_book(table, { sheet: 'Sheet1' });
  XLSX.writeFile(wb, `${fileName}.xlsx`);
};

const exportToCSV = (tableRef: React.RefObject<HTMLDivElement>, fileName: string) => {
  if (!tableRef.current) return;

  const table = tableRef.current.querySelector('table');
  if (!table) return;

  const wb = XLSX.utils.table_to_book(table, { sheet: 'Sheet1' });
  XLSX.writeFile(wb, `${fileName}.csv`);
};

const exportToPDF = async (tableRef: React.RefObject<HTMLDivElement>, fileName: string) => {
  if (!tableRef.current) return;

  // Get only the table element, not the entire container
  const table = tableRef.current.querySelector('table');
  if (!table) return;

  // Use html2canvas to capture only the table
  const canvas = await html2canvas(table);
  const imgData = canvas.toDataURL('image/png');

  // Create PDF
  const pdf = new jsPDF();
  const imgWidth = pdf.internal.pageSize.getWidth() - 20; // Add some margins
  const imgHeight = (canvas.height * imgWidth) / canvas.width;

  pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight); // Add margins
  pdf.save(`${fileName}.pdf`);
};

const copyToClipboard = (tableRef: React.RefObject<HTMLDivElement>) => {
  if (!tableRef.current) return;

  const table = tableRef.current.querySelector('table');
  if (!table) return;

  // Get table HTML
  const range = document.createRange();
  range.selectNode(table);
  window.getSelection()?.removeAllRanges();
  window.getSelection()?.addRange(range);
  document.execCommand('copy');
  window.getSelection()?.removeAllRanges();

  // Show success message (you might want to implement a toast notification)
  alert('Table copied to clipboard!');
};

const printTable = (tableRef: React.RefObject<HTMLDivElement>) => {
  if (!tableRef.current) return;

  // Get only the table element, not the entire container
  const table = tableRef.current.querySelector('table');
  if (!table) return;

  const printWindow = window.open('', '', 'height=600,width=800');
  if (printWindow) {
    printWindow.document.write('<html><head><title>Print Report</title>');
    printWindow.document.write('<style>table { border-collapse: collapse; width: 100%; } th, td { border: 1px solid #ddd; padding: 8px; text-align: left; } th { background-color: #f2f2f2; }</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.write(table.outerHTML);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.print();
  }
};
// Component to display Sales by Service report data in a table
const SalesByServiceTable = ({ startDate, endDate, client, service, staff, status, bookingType, onFiltersChange, triggerRefresh }: any) => {
  const [filters, setFilters] = useState<FilterParams>({});
  const [isFilterModalOpen, setIsFilterModalOpen] = useState(false);
  const [currentPage, setCurrentPage] = useState(1);
  const [itemsPerPage, setItemsPerPage] = useState(10); // 10 entries by default
  const [searchTerm, setSearchTerm] = useState('');
  const tableRef = useRef<HTMLDivElement>(null);

  // Use the RTK Query hook to fetch real data
  // Note: Only completed appointments are included in sales reports
  const { data, isLoading, isError, refetch } = useGetSalesByServiceReportQuery({
    period: startDate && endDate ? 'custom' : 'all',
    startDate: startDate ? new Date(startDate) : undefined,
    endDate: endDate ? new Date(endDate) : undefined,
    client: client && client !== 'all' ? client : undefined,
    service: service && service !== 'all' ? service : undefined,
    staff: staff && staff !== 'all' ? staff : undefined,
    // Status is fixed to 'completed' in the backend for sales reports
    bookingType: bookingType && bookingType !== 'all' ? bookingType : undefined
  });

  const handleFilterChange = (newFilters: FilterParams) => {
    setFilters(newFilters);
    setCurrentPage(1); // Reset to first page when filters change

    // Notify parent component about filter changes
    if (onFiltersChange) {
      onFiltersChange(newFilters);
    }
  };

  // Export functions
  const handleExport = (format: string) => {
    switch (format) {
      case 'excel':
        exportToExcel(tableRef, 'sales_by_service');
        break;
      case 'csv':
        exportToCSV(tableRef, 'sales_by_service');
        break;
      case 'pdf':
        exportToPDF(tableRef, 'sales_by_service');
        break;
      case 'copy':
        copyToClipboard(tableRef);
        break;
      case 'print':
        printTable(tableRef);
        break;
      default:
        break;
    }
  };

  // Trigger refetch when filter values change or when explicitly triggered
  useEffect(() => {
    refetch();
  }, [refetch, startDate, endDate, client, service, staff, status, bookingType, triggerRefresh]);

  // Extract services from the API response
  const services = data?.data?.salesByService || [];

  // Filter data based on search term
  const searchedServices = useMemo(() => {
    if (!searchTerm) return services;

    return services.filter((service: any) =>
      Object.values(service).some(value =>
        value && value.toString().toLowerCase().includes(searchTerm.toLowerCase())
      )
    );
  }, [services, searchTerm]);

  // Pagination logic
  const totalItems = searchedServices.length;
  const totalPages = Math.ceil(totalItems / itemsPerPage);
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const paginatedServices = searchedServices.slice(startIndex, endIndex);

  // Calculate total sales
  const totalSales = paginatedServices.reduce((sum: number, service: any) => sum + (service.totalSales || 0), 0);

  if (isLoading) {
    return (
      <div>
        <div className="flex justify-between items-center mb-4 gap-2">
          <div className="relative w-64">
            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              type="search"
              placeholder="Search..."
              className="pl-8"
              value={searchTerm}
              onChange={(e) => {
                setSearchTerm(e.target.value);
                setCurrentPage(1); // Reset to first page when search term changes
              }}
            />
          </div>
          <div className="flex gap-2">
            <Button onClick={() => setIsFilterModalOpen(true)}>
              <Filter className="mr-2 h-4 w-4" />
              Filters
            </Button>
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button>
                  <Download className="mr-2 h-4 w-4" />
                  Export
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent align="end">
                <DropdownMenuItem onClick={() => handleExport('copy')}>
                  <Copy className="mr-2 h-4 w-4" />
                  Copy
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('excel')}>
                  <FileSpreadsheet className="mr-2 h-4 w-4" />
                  Excel
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('csv')}>
                  <FileText className="mr-2 h-4 w-4" />
                  CSV
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('pdf')}>
                  <FileText className="mr-2 h-4 w-4" />
                  PDF
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('print')}>
                  <Printer className="mr-2 h-4 w-4" />
                  Print
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          </div>
        </div>
        <div className="rounded-md border">
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>Service</TableHead>
                <TableHead>Service Sold</TableHead>
                <TableHead>Gross Sale</TableHead>
                <TableHead>Discounts</TableHead>
                <TableHead>Offers</TableHead>
                <TableHead>Net Sale</TableHead>
                <TableHead>Tax</TableHead>
                <TableHead>Total Sales</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {[...Array(5)].map((_, index) => (
                <TableRow key={index}>
                  <TableCell>
                    <Skeleton className="h-4 w-32" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-16" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-20" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-20" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-24" />
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </div>
      </div>
    );
  }

  if (isError) {
    return (
      <div>
        <div className="flex justify-between items-center mb-4 gap-2">
          <div className="relative w-64">
            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              type="search"
              placeholder="Search..."
              className="pl-8"
              value={searchTerm}
              onChange={(e) => {
                setSearchTerm(e.target.value);
                setCurrentPage(1); // Reset to first page when search term changes
              }}
            />
          </div>
          <Button onClick={() => setIsFilterModalOpen(true)}>
            <Filter className="mr-2 h-4 w-4" />
            Filters
          </Button>
        </div>
        <div className="text-center py-4 text-red-500">
          Failed to load sales by service data. Please try again.
        </div>
      </div>
    );
  }

  if (paginatedServices.length === 0) {
    return (
      <div>
        <div className="flex justify-between items-center mb-4 gap-2">
          <div className="relative w-64">
            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              type="search"
              placeholder="Search..."
              className="pl-8"
              value={searchTerm}
              onChange={(e) => {
                setSearchTerm(e.target.value);
                setCurrentPage(1); // Reset to first page when search term changes
              }}
            />
          </div>
          <Button onClick={() => setIsFilterModalOpen(true)}>
            <Filter className="mr-2 h-4 w-4" />
            Filters
          </Button>
        </div>
        <div className="text-center py-4 text-gray-500">
          No sales by service data available.
        </div>
        <FilterModal
          isOpen={isFilterModalOpen}
          onClose={() => setIsFilterModalOpen(false)}
          onApplyFilters={handleFilterChange}
          cities={[]}
          initialFilters={filters}
          showStatusFilter={false}
          hideClientFilter={false}
          hideServiceFilter={false}
          hideStaffFilter={false}
          hideBookingTypeFilter={false}
        />
      </div>
    );
  }

  return (
    <div ref={tableRef}>
      <div className="flex justify-between items-center mb-4 gap-2">
        <div className="relative w-64">
          <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
          <Input
            type="search"
            placeholder="Search..."
            className="pl-8"
            value={searchTerm}
            onChange={(e) => {
              setSearchTerm(e.target.value);
              setCurrentPage(1); // Reset to first page when search term changes
            }}
          />
        </div>
        <div className="flex gap-2">
          <Button onClick={() => setIsFilterModalOpen(true)}>
            <Filter className="mr-2 h-4 w-4" />
            Filters
          </Button>
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button>
                <Download className="mr-2 h-4 w-4" />
                Export
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end">
              <DropdownMenuItem onClick={() => handleExport('copy')}>
                <Copy className="mr-2 h-4 w-4" />
                Copy
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('excel')}>
                <FileSpreadsheet className="mr-2 h-4 w-4" />
                Excel
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('csv')}>
                <FileText className="mr-2 h-4 w-4" />
                CSV
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('pdf')}>
                <FileText className="mr-2 h-4 w-4" />
                PDF
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('print')}>
                <Printer className="mr-2 h-4 w-4" />
                Print
              </DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
        </div>
      </div>

      <FilterModal
        isOpen={isFilterModalOpen}
        onClose={() => setIsFilterModalOpen(false)}
        onApplyFilters={handleFilterChange}
        cities={[]}
        initialFilters={filters}
        // Status filter is hidden for Sales by Service report as only completed appointments are shown
        showStatusFilter={false}
      />

      <div className="rounded-md border">
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead>Service</TableHead>
              <TableHead>Service Sold</TableHead>
              <TableHead>Gross Sale</TableHead>
              <TableHead>Discounts</TableHead>
              <TableHead>Offers</TableHead>
              <TableHead>Net Sale</TableHead>
              <TableHead>Tax</TableHead>
              <TableHead>Total Sales</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {paginatedServices.map((item: any, index: number) => {
              return (
                <TableRow key={index}>
                  <TableCell className="font-medium">{item.service || 'Unknown Service'}</TableCell>
                  <TableCell>{item.serviceSold || 0}</TableCell>
                  <TableCell>₹{typeof item.grossSale === 'number' ? item.grossSale.toFixed(2) : '0.00'}</TableCell>
                  <TableCell>₹{typeof item.discounts === 'number' ? item.discounts.toFixed(2) : '0.00'}</TableCell>
                  <TableCell>₹{typeof item.offers === 'number' ? item.offers.toFixed(2) : '0.00'}</TableCell>
                  <TableCell>₹{typeof item.netSale === 'number' ? item.netSale.toFixed(2) : '0.00'}</TableCell>
                  <TableCell>₹{typeof item.tax === 'number' ? item.tax.toFixed(2) : '0.00'}</TableCell>
                  <TableCell>₹{typeof item.totalSales === 'number' ? item.totalSales.toFixed(2) : '0.00'}</TableCell>
                </TableRow>
              );
            })}
            {/* Total Row */}
            <TableRow className="font-bold bg-gray-50">
              <TableCell>Total</TableCell>
              <TableCell>
                {paginatedServices.reduce((sum: number, item: any) => sum + (item.serviceSold || 0), 0)}
              </TableCell>
              <TableCell>
                ₹{paginatedServices.reduce((sum: number, item: any) => sum + (item.grossSale || 0), 0).toFixed(2)}
              </TableCell>
              <TableCell>
                ₹{paginatedServices.reduce((sum: number, item: any) => sum + (item.discounts || 0), 0).toFixed(2)}
              </TableCell>
              <TableCell>
                ₹{paginatedServices.reduce((sum: number, item: any) => sum + (item.offers || 0), 0).toFixed(2)}
              </TableCell>
              <TableCell>
                ₹{paginatedServices.reduce((sum: number, item: any) => sum + (item.netSale || 0), 0).toFixed(2)}
              </TableCell>
              <TableCell>
                ₹{paginatedServices.reduce((sum: number, item: any) => sum + (item.tax || 0), 0).toFixed(2)}
              </TableCell>
              <TableCell>
                ₹{paginatedServices.reduce((sum: number, item: any) => sum + (item.totalSales || 0), 0).toFixed(2)}
              </TableCell>
            </TableRow>
          </TableBody>
        </Table>
      </div>
      <Pagination
        className="mt-4"
        currentPage={currentPage}
        totalPages={totalPages}
        onPageChange={setCurrentPage}
        itemsPerPage={itemsPerPage}
        onItemsPerPageChange={setItemsPerPage}
        totalItems={totalItems}
      />
    </div>
  );
};

// Component to display Sales by Customer report data in a table
const SalesByCustomerTable = ({ startDate, endDate, client, service, staff, status, bookingType, onFiltersChange, triggerRefresh }: any) => {
  const [filters, setFilters] = useState<FilterParams>({});
  const [isFilterModalOpen, setIsFilterModalOpen] = useState(false);
  const [currentPage, setCurrentPage] = useState(1);
  const [itemsPerPage, setItemsPerPage] = useState(10); // 10 entries by default
  const [searchTerm, setSearchTerm] = useState('');
  const tableRef = useRef<HTMLDivElement>(null);

  // Use the RTK Query hook to fetch real data
  // Note: Only completed appointments are included in sales reports
  const { data, isLoading, isError, refetch } = useGetSalesByCustomerReportQuery({
    period: startDate && endDate ? 'custom' : 'all',
    startDate: startDate ? new Date(startDate) : undefined,
    endDate: endDate ? new Date(endDate) : undefined,
    client: client && client !== 'all' ? client : undefined,
    service: service && service !== 'all' ? service : undefined,
    staff: staff && staff !== 'all' ? staff : undefined,
    // Status is fixed to 'completed' in the backend for sales reports
    bookingType: bookingType && bookingType !== 'all' ? bookingType : undefined
  });

  const handleFilterChange = (newFilters: FilterParams) => {
    setFilters(newFilters);
    setCurrentPage(1); // Reset to first page when filters change

    // Notify parent component about filter changes
    if (onFiltersChange) {
      onFiltersChange(newFilters);
    }
  };

  // Export functions
  const handleExport = (format: string) => {
    switch (format) {
      case 'excel':
        exportToExcel(tableRef, 'sales_by_customer');
        break;
      case 'csv':
        exportToCSV(tableRef, 'sales_by_customer');
        break;
      case 'pdf':
        exportToPDF(tableRef, 'sales_by_customer');
        break;
      case 'copy':
        copyToClipboard(tableRef);
        break;
      case 'print':
        printTable(tableRef);
        break;
      default:
        break;
    }
  };

  // Trigger refetch when filter values change or when explicitly triggered
  useEffect(() => {
    refetch();
  }, [refetch, startDate, endDate, client, service, staff, status, bookingType, triggerRefresh]);

  // Extract customers from the API response
  const customers = data?.data?.salesByCustomer || [];

  // Filter data based on search term
  const searchedCustomers = useMemo(() => {
    if (!searchTerm) return customers;

    return customers.filter((customer: any) =>
      Object.values(customer).some(value =>
        value && value.toString().toLowerCase().includes(searchTerm.toLowerCase())
      )
    );
  }, [customers, searchTerm]);

  // Pagination logic
  const totalItems = searchedCustomers.length;
  const totalPages = Math.ceil(totalItems / itemsPerPage);
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const paginatedCustomers = searchedCustomers.slice(startIndex, endIndex);

  // Calculate total sales
  const totalSales = paginatedCustomers.reduce((sum: number, customer: any) => sum + (customer.totalSales || 0), 0);

  if (isLoading) {
    return (
      <div>
        <div className="flex justify-between items-center mb-4 gap-2">
          <div className="relative w-64">
            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              type="search"
              placeholder="Search..."
              className="pl-8"
              value={searchTerm}
              onChange={(e) => {
                setSearchTerm(e.target.value);
                setCurrentPage(1); // Reset to first page when search term changes
              }}
            />
          </div>
          <div className="flex gap-2">
            <Button onClick={() => setIsFilterModalOpen(true)}>
              <Filter className="mr-2 h-4 w-4" />
              Filters
            </Button>
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button>
                  <Download className="mr-2 h-4 w-4" />
                  Export
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent align="end">
                <DropdownMenuItem onClick={() => handleExport('copy')}>
                  <Copy className="mr-2 h-4 w-4" />
                  Copy
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('excel')}>
                  <FileSpreadsheet className="mr-2 h-4 w-4" />
                  Excel
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('csv')}>
                  <FileText className="mr-2 h-4 w-4" />
                  CSV
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('pdf')}>
                  <FileText className="mr-2 h-4 w-4" />
                  PDF
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('print')}>
                  <Printer className="mr-2 h-4 w-4" />
                  Print
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          </div>
        </div>
        <div className="rounded-md border">
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>Customer</TableHead>
                <TableHead>Service Sold</TableHead>
                <TableHead>Gross Sale</TableHead>
                <TableHead>Discounts</TableHead>
                <TableHead>Offers</TableHead>
                <TableHead>Net Sale</TableHead>
                <TableHead>Tax</TableHead>
                <TableHead>Total Sales</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {[...Array(5)].map((_, index) => (
                <TableRow key={index}>
                  <TableCell>
                    <Skeleton className="h-4 w-32" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-16" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-20" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-20" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-24" />
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </div>
      </div>
    );
  }

  if (isError) {
    return (
      <div>
        <div className="flex justify-between items-center mb-4 gap-2">
          <div className="relative w-64">
            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              type="search"
              placeholder="Search..."
              className="pl-8"
              value={searchTerm}
              onChange={(e) => {
                setSearchTerm(e.target.value);
                setCurrentPage(1); // Reset to first page when search term changes
              }}
            />
          </div>
          <Button onClick={() => setIsFilterModalOpen(true)}>
            <Filter className="mr-2 h-4 w-4" />
            Filters
          </Button>
        </div>
        <div className="text-center py-4 text-red-500">
          Failed to load sales by customer data. Please try again.
        </div>
      </div>
    );
  }

  if (paginatedCustomers.length === 0) {
    return (
      <div>
        <div className="flex justify-between items-center mb-4 gap-2">
          <div className="relative w-64">
            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              type="search"
              placeholder="Search..."
              className="pl-8"
              value={searchTerm}
              onChange={(e) => {
                setSearchTerm(e.target.value);
                setCurrentPage(1); // Reset to first page when search term changes
              }}
            />
          </div>
          <Button onClick={() => setIsFilterModalOpen(true)}>
            <Filter className="mr-2 h-4 w-4" />
            Filters
          </Button>
        </div>
        <div className="text-center py-4 text-gray-500">
          No sales by customer data available.
        </div>
        <FilterModal
          isOpen={isFilterModalOpen}
          onClose={() => setIsFilterModalOpen(false)}
          onApplyFilters={handleFilterChange}
          cities={[]}
          initialFilters={filters}
          showStatusFilter={false}
          hideClientFilter={false}
          hideServiceFilter={false}
          hideStaffFilter={false}
          hideBookingTypeFilter={false}
        />
      </div>
    );
  }

  return (
    <div ref={tableRef}>
      <div className="flex justify-between items-center mb-4 gap-2">
        <div className="relative w-64">
          <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
          <Input
            type="search"
            placeholder="Search..."
            className="pl-8"
            value={searchTerm}
            onChange={(e) => {
              setSearchTerm(e.target.value);
              setCurrentPage(1); // Reset to first page when search term changes
            }}
          />
        </div>
        <div className="flex gap-2">
          <Button onClick={() => setIsFilterModalOpen(true)}>
            <Filter className="mr-2 h-4 w-4" />
            Filters
          </Button>
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button>
                <Download className="mr-2 h-4 w-4" />
                Export
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end">
              <DropdownMenuItem onClick={() => handleExport('copy')}>
                <Copy className="mr-2 h-4 w-4" />
                Copy
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('excel')}>
                <FileSpreadsheet className="mr-2 h-4 w-4" />
                Excel
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('csv')}>
                <FileText className="mr-2 h-4 w-4" />
                CSV
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('pdf')}>
                <FileText className="mr-2 h-4 w-4" />
                PDF
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('print')}>
                <Printer className="mr-2 h-4 w-4" />
                Print
              </DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
        </div>
      </div>

      <FilterModal
        isOpen={isFilterModalOpen}
        onClose={() => setIsFilterModalOpen(false)}
        onApplyFilters={handleFilterChange}
        cities={[]}
        initialFilters={filters}
        // Status filter is hidden for Sales by Customer report as only completed appointments are shown
        showStatusFilter={false}
      />

      <div className="rounded-md border">
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead>Customer</TableHead>
              <TableHead>Service Sold</TableHead>
              <TableHead>Gross Sale</TableHead>
              <TableHead>Discounts</TableHead>
              <TableHead>Offers</TableHead>
              <TableHead>Net Sale</TableHead>
              <TableHead>Tax</TableHead>
              <TableHead>Total Sales</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {paginatedCustomers.map((item: any, index: number) => {
              return (
                <TableRow key={index}>
                  <TableCell className="font-medium">{item.customer || 'Unknown Customer'}</TableCell>
                  <TableCell>{item.serviceSold || 0}</TableCell>
                  <TableCell>₹{typeof item.grossSale === 'number' ? item.grossSale.toFixed(2) : '0.00'}</TableCell>
                  <TableCell>₹{typeof item.discounts === 'number' ? item.discounts.toFixed(2) : '0.00'}</TableCell>
                  <TableCell>₹{typeof item.offers === 'number' ? item.offers.toFixed(2) : '0.00'}</TableCell>
                  <TableCell>₹{typeof item.netSale === 'number' ? item.netSale.toFixed(2) : '0.00'}</TableCell>
                  <TableCell>₹{typeof item.tax === 'number' ? item.tax.toFixed(2) : '0.00'}</TableCell>
                  <TableCell>₹{typeof item.totalSales === 'number' ? item.totalSales.toFixed(2) : '0.00'}</TableCell>
                </TableRow>
              );
            })}
            {/* Total Row */}
            <TableRow className="font-bold bg-gray-50">
              <TableCell>Total</TableCell>
              <TableCell>
                {paginatedCustomers.reduce((sum: number, item: any) => sum + (item.serviceSold || 0), 0)}
              </TableCell>
              <TableCell>
                ₹{paginatedCustomers.reduce((sum: number, item: any) => sum + (item.grossSale || 0), 0).toFixed(2)}
              </TableCell>
              <TableCell>
                ₹{paginatedCustomers.reduce((sum: number, item: any) => sum + (item.discounts || 0), 0).toFixed(2)}
              </TableCell>
              <TableCell>
                ₹{paginatedCustomers.reduce((sum: number, item: any) => sum + (item.offers || 0), 0).toFixed(2)}
              </TableCell>
              <TableCell>
                ₹{paginatedCustomers.reduce((sum: number, item: any) => sum + (item.netSale || 0), 0).toFixed(2)}
              </TableCell>
              <TableCell>
                ₹{paginatedCustomers.reduce((sum: number, item: any) => sum + (item.tax || 0), 0).toFixed(2)}
              </TableCell>
              <TableCell>
                ₹{paginatedCustomers.reduce((sum: number, item: any) => sum + (item.totalSales || 0), 0).toFixed(2)}
              </TableCell>
            </TableRow>
          </TableBody>
        </Table>
      </div>
      <Pagination
        className="mt-4"
        currentPage={currentPage}
        totalPages={totalPages}
        onPageChange={setCurrentPage}
        itemsPerPage={itemsPerPage}
        onItemsPerPageChange={setItemsPerPage}
        totalItems={totalItems}
      />
    </div>
  );
};

// Component to display Product Summary report data in a table
const ProductSummaryTable = ({ product, category, brand, status, isActive, region, onFiltersChange, triggerRefresh }: any) => {
  const [filters, setFilters] = useState<FilterParams>({});
  const [isFilterModalOpen, setIsFilterModalOpen] = useState(false);
  const [currentPage, setCurrentPage] = useState(1);
  const [itemsPerPage, setItemsPerPage] = useState(10); // 10 entries by default
  const [searchTerm, setSearchTerm] = useState('');
  const tableRef = useRef<HTMLDivElement>(null);

  // Use the RTK Query hook to fetch real data
  const { data, isLoading, isError, refetch } = useGetProductSummaryReportQuery({
    product: product && product !== 'all' ? product : undefined,
    category: category && category !== 'all' ? category : undefined,
    brand: brand && brand !== 'all' ? brand : undefined,
    status: status && status !== 'all' ? status : undefined,
    isActive: isActive !== undefined ? isActive : undefined,
    region: region && region !== 'all' ? region : undefined
  });

  const handleFilterChange = (newFilters: FilterParams) => {
    setFilters(newFilters);
    setCurrentPage(1); // Reset to first page when filters change

    // Notify parent component about filter changes
    if (onFiltersChange) {
      onFiltersChange(newFilters);
    }
  };

  // Export functions
  const handleExport = (format: string) => {
    switch (format) {
      case 'excel':
        exportToExcel(tableRef, 'product_summary');
        break;
      case 'csv':
        exportToCSV(tableRef, 'product_summary');
        break;
      case 'pdf':
        exportToPDF(tableRef, 'product_summary');
        break;
      case 'copy':
        copyToClipboard(tableRef);
        break;
      case 'print':
        printTable(tableRef);
        break;
      default:
        break;
    }
  };

  // Trigger refetch when filter values change or when explicitly triggered
  useEffect(() => {
    refetch();
  }, [refetch, product, category, brand, status, isActive, triggerRefresh]);

  // Extract products from the API response
  const products = data?.data?.products || [];

  // Filter data based on search term
  const searchedProducts = useMemo(() => {
    if (!searchTerm) return products;

    return products.filter((product: any) =>
      Object.values(product).some(value =>
        value && value.toString().toLowerCase().includes(searchTerm.toLowerCase())
      )
    );
  }, [products, searchTerm]);

  // Pagination logic
  const totalItems = searchedProducts.length;
  const totalPages = Math.ceil(totalItems / itemsPerPage);
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const paginatedProducts = searchedProducts.slice(startIndex, endIndex);

  if (isLoading) {
    return (
      <div>
        <div className="flex justify-between items-center mb-4 gap-2">
          <div className="relative w-64">
            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              type="search"
              placeholder="Search..."
              className="pl-8"
              value={searchTerm}
              onChange={(e) => {
                setSearchTerm(e.target.value);
                setCurrentPage(1); // Reset to first page when search term changes
              }}
            />
          </div>
          <div className="flex gap-2">
            <Button onClick={() => setIsFilterModalOpen(true)}>
              <Filter className="mr-2 h-4 w-4" />
              Filters
            </Button>
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button>
                  <Download className="mr-2 h-4 w-4" />
                  Export
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent align="end">
                <DropdownMenuItem onClick={() => handleExport('copy')}>
                  <Copy className="mr-2 h-4 w-4" />
                  Copy
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('excel')}>
                  <FileSpreadsheet className="mr-2 h-4 w-4" />
                  Excel
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('csv')}>
                  <FileText className="mr-2 h-4 w-4" />
                  CSV
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('pdf')}>
                  <FileText className="mr-2 h-4 w-4" />
                  PDF
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('print')}>
                  <Printer className="mr-2 h-4 w-4" />
                  Print
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          </div>
        </div>
        <div className="rounded-md border">
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>Product Name</TableHead>
                <TableHead>Brand</TableHead>
                <TableHead>Category</TableHead>
                <TableHead>Product Form</TableHead>
                <TableHead>Price</TableHead>
                <TableHead>Sale Price</TableHead>
                <TableHead>Stock</TableHead>
                <TableHead>Status</TableHead>
                <TableHead>Is Active</TableHead>
                <TableHead>Region</TableHead>
                <TableHead>Created Date</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {[...Array(5)].map((_, index) => (
                <TableRow key={index}>
                  <TableCell>
                    <Skeleton className="h-4 w-32" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-20" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-20" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-20" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-16" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-16" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-16" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-20" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-16" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-16" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-24" />
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </div>
      </div>
    );
  }

  if (isError) {
    return (
      <div>
        <div className="flex justify-between items-center mb-4 gap-2">
          <div className="relative w-64">
            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              type="search"
              placeholder="Search..."
              className="pl-8"
              value={searchTerm}
              onChange={(e) => {
                setSearchTerm(e.target.value);
                setCurrentPage(1); // Reset to first page when search term changes
              }}
            />
          </div>
          <Button onClick={() => setIsFilterModalOpen(true)}>
            <Filter className="mr-2 h-4 w-4" />
            Filters
          </Button>
        </div>
        <div className="text-center py-4 text-red-500">
          Failed to load product summary data. Please try again.
        </div>
      </div>
    );
  }

  if (paginatedProducts.length === 0) {
    return (
      <div>
        <div className="flex justify-between items-center mb-4 gap-2">
          <div className="relative w-64">
            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              type="search"
              placeholder="Search..."
              className="pl-8"
              value={searchTerm}
              onChange={(e) => {
                setSearchTerm(e.target.value);
                setCurrentPage(1); // Reset to first page when search term changes
              }}
            />
          </div>
          <Button onClick={() => setIsFilterModalOpen(true)}>
            <Filter className="mr-2 h-4 w-4" />
            Filters
          </Button>
        </div>
        <div className="text-center py-4 text-gray-500">
          No product data available.
        </div>
        <FilterModal
          isOpen={isFilterModalOpen}
          onClose={() => setIsFilterModalOpen(false)}
          onApplyFilters={handleFilterChange}
          cities={[]}
          initialFilters={filters}
          showProductFilter={true}
          showCategoryFilter={true}
          showBrandFilter={true}
          showRegionFilter={true}
          hideBookingTypeFilter={true}
          hideClientFilter={true}
          hideServiceFilter={true}
          hideStaffFilter={true}
        />
      </div>
    );
  }

  return (
    <div ref={tableRef}>
      <div className="flex justify-between items-center mb-4 gap-2">
        <div className="relative w-64">
          <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
          <Input
            type="search"
            placeholder="Search..."
            className="pl-8"
            value={searchTerm}
            onChange={(e) => {
              setSearchTerm(e.target.value);
              setCurrentPage(1); // Reset to first page when search term changes
            }}
          />
        </div>
        <div className="flex gap-2">
          <Button onClick={() => setIsFilterModalOpen(true)}>
            <Filter className="mr-2 h-4 w-4" />
            Filters
          </Button>
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button>
                <Download className="mr-2 h-4 w-4" />
                Export
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end">
              <DropdownMenuItem onClick={() => handleExport('copy')}>
                <Copy className="mr-2 h-4 w-4" />
                Copy
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('excel')}>
                <FileSpreadsheet className="mr-2 h-4 w-4" />
                Excel
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('csv')}>
                <FileText className="mr-2 h-4 w-4" />
                CSV
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('pdf')}>
                <FileText className="mr-2 h-4 w-4" />
                PDF
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('print')}>
                <Printer className="mr-2 h-4 w-4" />
                Print
              </DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
        </div>
      </div>

      <FilterModal
        isOpen={isFilterModalOpen}
        onClose={() => setIsFilterModalOpen(false)}
        onApplyFilters={handleFilterChange}
        cities={[]}
        initialFilters={filters}
        showProductFilter={true}
        showCategoryFilter={true}
        showBrandFilter={true}
        showRegionFilter={true}
        hideBookingTypeFilter={true}
        hideClientFilter={true}
        hideServiceFilter={true}
        hideStaffFilter={true}
      />

      <div className="rounded-md border">
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead>Product Name</TableHead>
              <TableHead>Brand</TableHead>
              <TableHead>Category</TableHead>
              <TableHead>Product Form</TableHead>
              <TableHead>Price</TableHead>
              <TableHead>Sale Price</TableHead>
              <TableHead>Stock</TableHead>
              <TableHead>Status</TableHead>
              <TableHead>Is Active</TableHead>
              <TableHead>Region</TableHead>
              <TableHead>Created Date</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {paginatedProducts.map((item: any, index: number) => {
              return (
                <TableRow key={index}>
                  <TableCell className="font-medium">{item.productName}</TableCell>
                  <TableCell>{item.brand}</TableCell>
                  <TableCell>{item.category}</TableCell>
                  <TableCell>{item.productForm}</TableCell>
                  <TableCell>₹{typeof item.price === 'number' ? item.price.toFixed(2) : '0.00'}</TableCell>
                  <TableCell>₹{typeof item.salePrice === 'number' ? item.salePrice.toFixed(2) : '0.00'}</TableCell>
                  <TableCell>{item.stock}</TableCell>
                  <TableCell>
                    <Badge variant={item.status === 'approved' ? 'default' : item.status === 'pending' ? 'secondary' : 'destructive'}>
                      {item.status}
                    </Badge>
                  </TableCell>
                  <TableCell>
                    {item.isActive ? (
                      <Badge variant="default">Active</Badge>
                    ) : (
                      <Badge variant="secondary">Inactive</Badge>
                    )}
                  </TableCell>
                  <TableCell>{item.region || 'N/A'}</TableCell>
                  <TableCell>
                    {item.createdAt ? new Date(item.createdAt).toLocaleDateString() : 'N/A'}
                  </TableCell>
                </TableRow>
              );
            })}
          </TableBody>
        </Table>
      </div>
      <Pagination
        className="mt-4"
        currentPage={currentPage}
        totalPages={totalPages}
        onPageChange={setCurrentPage}
        itemsPerPage={itemsPerPage}
        onItemsPerPageChange={setItemsPerPage}
        totalItems={totalItems}
      />
    </div>
  );
};

// Component to display Inventory/Stock report data in a table
const InventoryStockTable = ({ product, category, brand, onFiltersChange, triggerRefresh }: any) => {
  const [filters, setFilters] = useState<FilterParams>({});
  const [isFilterModalOpen, setIsFilterModalOpen] = useState(false);
  const [currentPage, setCurrentPage] = useState(1);
  const [itemsPerPage, setItemsPerPage] = useState(10); // 10 entries by default
  const [searchTerm, setSearchTerm] = useState('');
  const tableRef = useRef<HTMLDivElement>(null);

  // Use the RTK Query hook to fetch real data
  const { data, isLoading, isError, refetch } = useGetInventoryStockReportQuery({
    product: product && product !== 'all' ? product : undefined,
    category: category && category !== 'all' ? category : undefined,
    brand: brand && brand !== 'all' ? brand : undefined
  });

  const handleFilterChange = (newFilters: FilterParams) => {
    setFilters(newFilters);
    setCurrentPage(1); // Reset to first page when filters change

    // Notify parent component about filter changes
    if (onFiltersChange) {
      onFiltersChange(newFilters);
    }
  };

  // Export functions
  const handleExport = (format: string) => {
    switch (format) {
      case 'excel':
        exportToExcel(tableRef, 'inventory_stock_report');
        break;
      case 'csv':
        exportToCSV(tableRef, 'inventory_stock_report');
        break;
      case 'pdf':
        exportToPDF(tableRef, 'inventory_stock_report');
        break;
      case 'copy':
        copyToClipboard(tableRef);
        break;
      case 'print':
        printTable(tableRef);
        break;
      default:
        break;
    }
  };

  // Trigger refetch when filter values change or when explicitly triggered
  useEffect(() => {
    refetch();
  }, [refetch, product, category, brand, triggerRefresh]);

  // Extract products from the API response
  const products = data?.data?.products || [];

  // Filter data based on search term
  const searchedProducts = useMemo(() => {
    if (!searchTerm) return products;

    return products.filter((product: any) =>
      Object.values(product).some(value =>
        value && value.toString().toLowerCase().includes(searchTerm.toLowerCase())
      )
    );
  }, [products, searchTerm]);

  // Pagination logic
  const totalItems = searchedProducts.length;
  const totalPages = Math.ceil(totalItems / itemsPerPage);
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const paginatedProducts = searchedProducts.slice(startIndex, endIndex);

  if (isLoading) {
    return (
      <div>
        <div className="flex justify-between items-center mb-4">
          <div className="relative w-64">
            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              type="search"
              placeholder="Search..."
              className="pl-8"
              value={searchTerm}
              onChange={(e) => {
                setSearchTerm(e.target.value);
                setCurrentPage(1); // Reset to first page when search term changes
              }}
            />
          </div>
          <div className="flex gap-2">
            <Button onClick={() => setIsFilterModalOpen(true)}>
              <Filter className="mr-2 h-4 w-4" />
              Filters
            </Button>
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button>
                  <Download className="mr-2 h-4 w-4" />
                  Export
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent align="end">
                <DropdownMenuItem onClick={() => handleExport('copy')}>
                  <Copy className="mr-2 h-4 w-4" />
                  Copy
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('excel')}>
                  <FileSpreadsheet className="mr-2 h-4 w-4" />
                  Excel
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('csv')}>
                  <FileText className="mr-2 h-4 w-4" />
                  CSV
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('pdf')}>
                  <Printer className="mr-2 h-4 w-4" />
                  PDF
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('print')}>
                  <Printer className="mr-2 h-4 w-4" />
                  Print
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          </div>
        </div>

        <FilterModal
          isOpen={isFilterModalOpen}
          onClose={() => setIsFilterModalOpen(false)}
          onApplyFilters={handleFilterChange}
          cities={[]}
          initialFilters={filters}
          showProductFilter={true}
          showCategoryFilter={true}
          showBrandFilter={true}
          hideBookingTypeFilter={true}
          hideClientFilter={true}
          hideServiceFilter={true}
          hideStaffFilter={true}
        />

        <div className="rounded-md border">
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>Product Name</TableHead>
                <TableHead>Stock Available</TableHead>
                <TableHead>Stock Status</TableHead>
                <TableHead>Example Insight</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {[...Array(5)].map((_, index) => (
                <TableRow key={index}>
                  <TableCell>
                    <Skeleton className="h-4 w-32" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-20" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-20" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-32" />
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </div>
      </div>
    );
  }

  if (isError) {
    return (
      <div>
        <div className="flex justify-between items-center mb-4">
          <div className="relative w-64">
            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              type="search"
              placeholder="Search..."
              className="pl-8"
              value={searchTerm}
              onChange={(e) => {
                setSearchTerm(e.target.value);
                setCurrentPage(1); // Reset to first page when search term changes
              }}
            />
          </div>
          <div className="flex gap-2">
            <Button onClick={() => setIsFilterModalOpen(true)}>
              <Filter className="mr-2 h-4 w-4" />
              Filters
            </Button>
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button>
                  <Download className="mr-2 h-4 w-4" />
                  Export
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent align="end">
                <DropdownMenuItem onClick={() => handleExport('copy')}>
                  <Copy className="mr-2 h-4 w-4" />
                  Copy
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('excel')}>
                  <FileSpreadsheet className="mr-2 h-4 w-4" />
                  Excel
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('csv')}>
                  <FileText className="mr-2 h-4 w-4" />
                  CSV
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('pdf')}>
                  <Printer className="mr-2 h-4 w-4" />
                  PDF
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('print')}>
                  <Printer className="mr-2 h-4 w-4" />
                  Print
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          </div>
        </div>
        <div className="text-center py-4 text-red-500">
          Failed to load inventory/stock data. Please try again.
        </div>
      </div>
    );
  }

  if (paginatedProducts.length === 0) {
    return (
      <div>
        <div className="flex justify-between items-center mb-4">
          <div className="relative w-64">
            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              type="search"
              placeholder="Search..."
              className="pl-8"
              value={searchTerm}
              onChange={(e) => {
                setSearchTerm(e.target.value);
                setCurrentPage(1); // Reset to first page when search term changes
              }}
            />
          </div>
          <div className="flex gap-2">
            <Button onClick={() => setIsFilterModalOpen(true)}>
              <Filter className="mr-2 h-4 w-4" />
              Filters
            </Button>
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button>
                  <Download className="mr-2 h-4 w-4" />
                  Export
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent align="end">
                <DropdownMenuItem onClick={() => handleExport('copy')}>
                  <Copy className="mr-2 h-4 w-4" />
                  Copy
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('excel')}>
                  <FileSpreadsheet className="mr-2 h-4 w-4" />
                  Excel
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('csv')}>
                  <FileText className="mr-2 h-4 w-4" />
                  CSV
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('pdf')}>
                  <Printer className="mr-2 h-4 w-4" />
                  PDF
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('print')}>
                  <Printer className="mr-2 h-4 w-4" />
                  Print
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          </div>
        </div>
        <div className="text-center py-4 text-gray-500">
          No inventory/stock data available.
        </div>
        <FilterModal
          isOpen={isFilterModalOpen}
          onClose={() => setIsFilterModalOpen(false)}
          onApplyFilters={handleFilterChange}
          cities={[]}
          initialFilters={filters}
          showProductFilter={true}
          showCategoryFilter={true}
          showBrandFilter={true}
          hideBookingTypeFilter={true}
          hideClientFilter={true}
          hideServiceFilter={true}
          hideStaffFilter={true}
        />
      </div>
    );
  }

  return (
    <div ref={tableRef}>
      <div className="flex justify-between items-center mb-4">
        <div className="relative w-64">
          <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
          <Input
            type="search"
            placeholder="Search..."
            className="pl-8"
            value={searchTerm}
            onChange={(e) => {
              setSearchTerm(e.target.value);
              setCurrentPage(1); // Reset to first page when search term changes
            }}
          />
        </div>
        <div className="flex gap-2">
          <Button onClick={() => setIsFilterModalOpen(true)}>
            <Filter className="mr-2 h-4 w-4" />
            Filters
          </Button>
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button>
                <Download className="mr-2 h-4 w-4" />
                Export
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end">
              <DropdownMenuItem onClick={() => handleExport('copy')}>
                <Copy className="mr-2 h-4 w-4" />
                Copy
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('excel')}>
                <FileSpreadsheet className="mr-2 h-4 w-4" />
                Excel
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('csv')}>
                <FileText className="mr-2 h-4 w-4" />
                CSV
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('pdf')}>
                <Printer className="mr-2 h-4 w-4" />
                PDF
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('print')}>
                <Printer className="mr-2 h-4 w-4" />
                Print
              </DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
        </div>
      </div>
      <div className="rounded-md border">
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead>Product Name</TableHead>
              <TableHead>Stock Available</TableHead>
              <TableHead>Stock Status</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {paginatedProducts.map((item: any, index: number) => {
              return (
                <TableRow key={index}>
                  <TableCell className="font-medium">{item.productName}</TableCell>
                  <TableCell>{item.stockAvailable}</TableCell>
                  <TableCell>
                    <Badge variant={item.stockStatus === 'In Stock' ? 'default' : item.stockStatus === 'Low Stock' ? 'secondary' : 'destructive'}>
                      {item.stockStatus}
                    </Badge>
                  </TableCell>
                </TableRow>
              );
            })}
          </TableBody>
        </Table>
      </div>
      <Pagination
        className="mt-4"
        currentPage={currentPage}
        totalPages={totalPages}
        onPageChange={setCurrentPage}
        itemsPerPage={itemsPerPage}
        onItemsPerPageChange={setItemsPerPage}
        totalItems={totalItems}
      />

      <FilterModal
        isOpen={isFilterModalOpen}
        onClose={() => setIsFilterModalOpen(false)}
        onApplyFilters={handleFilterChange}
        cities={[]}
        initialFilters={filters}
        showProductFilter={true}
        showCategoryFilter={true}
        showBrandFilter={true}
        hideBookingTypeFilter={true}
        hideClientFilter={true}
        hideServiceFilter={true}
        hideStaffFilter={true}
      />
    </div>
  );
};

// Component to display Sales by Product report data in a table
const SalesByProductTable = ({ product, category, brand, status, isActive, onFiltersChange, triggerRefresh }: any) => {
  const [filters, setFilters] = useState<FilterParams>({});
  const [isFilterModalOpen, setIsFilterModalOpen] = useState(false);
  const [currentPage, setCurrentPage] = useState(1);
  const [itemsPerPage, setItemsPerPage] = useState(10); // 10 entries by default
  const [searchTerm, setSearchTerm] = useState('');
  const tableRef = useRef<HTMLDivElement>(null);

  // Use the RTK Query hook to fetch real data
  const { data, isLoading, isError, refetch } = useGetSalesByProductReportQuery({
    product: product && product !== 'all' ? product : undefined,
    category: category && category !== 'all' ? category : undefined,
    brand: brand && brand !== 'all' ? brand : undefined,
    status: status && status !== 'all' ? status : undefined,
    isActive: isActive !== undefined ? isActive : undefined
  });

  const handleFilterChange = (newFilters: FilterParams) => {
    setFilters(newFilters);
    setCurrentPage(1); // Reset to first page when filters change

    // Notify parent component about filter changes
    if (onFiltersChange) {
      onFiltersChange(newFilters);
    }
  };

  // Export functions
  const handleExport = (format: string) => {
    switch (format) {
      case 'excel':
        exportToExcel(tableRef, 'sales_by_product');
        break;
      case 'csv':
        exportToCSV(tableRef, 'sales_by_product');
        break;
      case 'pdf':
        exportToPDF(tableRef, 'sales_by_product');
        break;
      case 'copy':
        copyToClipboard(tableRef);
        break;
      case 'print':
        printTable(tableRef);
        break;
      default:
        break;
    }
  };

  // Trigger refetch when filter values change or when explicitly triggered
  useEffect(() => {
    refetch();
  }, [refetch, product, category, brand, status, isActive, triggerRefresh]);

  // Extract products from the API response
  const products = data?.data?.salesByProduct || [];

  // Filter data based on search term
  const searchedProducts = useMemo(() => {
    if (!searchTerm) return products;

    return products.filter((product: any) =>
      Object.values(product).some(value =>
        value && value.toString().toLowerCase().includes(searchTerm.toLowerCase())
      )
    );
  }, [products, searchTerm]);

  // Pagination logic
  const totalItems = searchedProducts.length;
  const totalPages = Math.ceil(totalItems / itemsPerPage);
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const paginatedProducts = searchedProducts.slice(startIndex, endIndex);

  // Calculate totals
  const totalUnitsSold = paginatedProducts.filter((item: any) => item.status === 'delivered').reduce((sum: number, product: any) => sum + (product.quantitySold || product.unitsSold || 0), 0);
  const totalGrossSale = paginatedProducts.filter((item: any) => item.status === 'delivered').reduce((sum: number, product: any) => sum + (product.grossSales || product.grossSale || 0), 0);
  const totalDiscounts = paginatedProducts.filter((item: any) => item.status === 'delivered').reduce((sum: number, product: any) => sum + (product.discountAmount || product.discounts || 0), 0);
  const totalOffers = paginatedProducts.filter((item: any) => item.status === 'delivered').reduce((sum: number, product: any) => sum + (product.offers || 0), 0);
  const totalNetSale = paginatedProducts.filter((item: any) => item.status === 'delivered').reduce((sum: number, product: any) => sum + (product.netSales || product.netSale || 0), 0);
  const totalTax = paginatedProducts.filter((item: any) => item.status === 'delivered').reduce((sum: number, product: any) => sum + (product.taxAmount || product.tax || 0), 0);
  const totalSales = paginatedProducts.filter((item: any) => item.status === 'delivered').reduce((sum: number, product: any) => sum + (product.totalSales || 0), 0);

  if (isLoading) {
    return (
      <div>
        <div className="flex justify-between items-center mb-4 gap-2">
          <div className="relative w-64">
            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              type="search"
              placeholder="Search..."
              className="pl-8"
              value={searchTerm}
              onChange={(e) => {
                setSearchTerm(e.target.value);
                setCurrentPage(1); // Reset to first page when search term changes
              }}
            />
          </div>
          <div className="flex gap-2">
            <Button onClick={() => setIsFilterModalOpen(true)}>
              <Filter className="mr-2 h-4 w-4" />
              Filters
            </Button>
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button>
                  <Download className="mr-2 h-4 w-4" />
                  Export
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent align="end">
                <DropdownMenuItem onClick={() => handleExport('copy')}>
                  <Copy className="mr-2 h-4 w-4" />
                  Copy
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('excel')}>
                  <FileSpreadsheet className="mr-2 h-4 w-4" />
                  Excel
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('csv')}>
                  <FileText className="mr-2 h-4 w-4" />
                  CSV
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('pdf')}>
                  <FileText className="mr-2 h-4 w-4" />
                  PDF
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('print')}>
                  <Printer className="mr-2 h-4 w-4" />
                  Print
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          </div>
        </div>
        <div className="rounded-md border">
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>Product ID</TableHead>
                <TableHead>Product Name</TableHead>
                <TableHead>Brand</TableHead>
                <TableHead>Product Category</TableHead>
                <TableHead>Quantity Sold</TableHead>
                <TableHead>Gross Sales</TableHead>
                <TableHead>Discount Amount</TableHead>
                <TableHead>Net Sales</TableHead>
                <TableHead>Tax Amount</TableHead>
                <TableHead>Total Sales</TableHead>
                <TableHead>Average Selling Price</TableHead>
                <TableHead>COGS</TableHead>
                <TableHead>Gross Profit</TableHead>
                <TableHead>Gross Margin %</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {[...Array(5)].map((_, index) => (
                <TableRow key={index}>
                  <TableCell>
                    <Skeleton className="h-4 w-20" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-32" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-20" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-24" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-16" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-20" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-20" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-20" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-20" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-20" />
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </div>
      </div>
    );
  }

  if (isError) {
    return (
      <div>
        <div className="flex justify-between items-center mb-4 gap-2">
          <div className="relative w-64">
            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              type="search"
              placeholder="Search..."
              className="pl-8"
              value={searchTerm}
              onChange={(e) => {
                setSearchTerm(e.target.value);
                setCurrentPage(1); // Reset to first page when search term changes
              }}
            />
          </div>
          <Button onClick={() => setIsFilterModalOpen(true)}>
            <Filter className="mr-2 h-4 w-4" />
            Filters
          </Button>
        </div>
        <div className="text-center py-4 text-red-500">
          Failed to load sales by product data. Please try again.
        </div>
      </div>
    );
  }

  if (paginatedProducts.length === 0) {
    return (
      <div>
        <div className="flex justify-between items-center mb-4 gap-2">
          <div className="relative w-64">
            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              type="search"
              placeholder="Search..."
              className="pl-8"
              value={searchTerm}
              onChange={(e) => {
                setSearchTerm(e.target.value);
                setCurrentPage(1); // Reset to first page when search term changes
              }}
            />
          </div>
          <Button onClick={() => setIsFilterModalOpen(true)}>
            <Filter className="mr-2 h-4 w-4" />
            Filters
          </Button>
        </div>
        <div className="text-center py-4 text-gray-500">
          No sales by product data available.
        </div>
        <FilterModal
          isOpen={isFilterModalOpen}
          onClose={() => setIsFilterModalOpen(false)}
          onApplyFilters={handleFilterChange}
          cities={[]}
          initialFilters={filters}
          showProductFilter={true}
          showCategoryFilter={true}
          showBrandFilter={true}
          hideBookingTypeFilter={true}
          hideClientFilter={true}
          hideServiceFilter={true}
          hideStaffFilter={true}
        />
      </div>
    );
  }

  return (
    <div ref={tableRef}>
      <div className="flex justify-between items-center mb-4 gap-2">
        <div className="relative w-64">
          <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
          <Input
            type="search"
            placeholder="Search..."
            className="pl-8"
            value={searchTerm}
            onChange={(e) => {
              setSearchTerm(e.target.value);
              setCurrentPage(1); // Reset to first page when search term changes
            }}
          />
        </div>
        <div className="flex gap-2">
          <Button onClick={() => setIsFilterModalOpen(true)}>
            <Filter className="mr-2 h-4 w-4" />
            Filters
          </Button>
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button>
                <Download className="mr-2 h-4 w-4" />
                Export
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end">
              <DropdownMenuItem onClick={() => handleExport('copy')}>
                <Copy className="mr-2 h-4 w-4" />
                Copy
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('excel')}>
                <FileSpreadsheet className="mr-2 h-4 w-4" />
                Excel
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('csv')}>
                <FileText className="mr-2 h-4 w-4" />
                CSV
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('pdf')}>
                <FileText className="mr-2 h-4 w-4" />
                PDF
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('print')}>
                <Printer className="mr-2 h-4 w-4" />
                Print
              </DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
        </div>
      </div>

      <FilterModal
        isOpen={isFilterModalOpen}
        onClose={() => setIsFilterModalOpen(false)}
        onApplyFilters={handleFilterChange}
        cities={[]}
        initialFilters={filters}
        showProductFilter={true}
        showCategoryFilter={true}
        showBrandFilter={true}
        hideBookingTypeFilter={true}
        hideClientFilter={true}
        hideServiceFilter={true}
        hideStaffFilter={true}
      />

      <div className="rounded-md border">
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead>Product ID</TableHead>
              <TableHead>Product Name</TableHead>
              <TableHead>Brand</TableHead>
              <TableHead>Product Category</TableHead>
              <TableHead>Quantity Sold</TableHead>
              <TableHead>Gross Sales</TableHead>
              <TableHead>Discount Amount</TableHead>
              <TableHead>Net Sales</TableHead>
              <TableHead>Tax Amount</TableHead>
              <TableHead>Total Sales</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {paginatedProducts.map((item: any, index: number) => {
              // Only show products with delivered status
              if (item.status !== 'delivered') return null;

              return (
                <TableRow key={index}>
                  <TableCell className="font-medium">{item.productId || 'N/A'}</TableCell>
                  <TableCell>{item.productName || item.product || 'Unknown Product'}</TableCell>
                  <TableCell>{item.brand || 'N/A'}</TableCell>
                  <TableCell>{item.category || 'N/A'}</TableCell>
                  <TableCell>{item.quantitySold || item.unitsSold || 0}</TableCell>
                  <TableCell>₹{typeof item.grossSales === 'number' ? item.grossSales.toFixed(2) : typeof item.grossSale === 'number' ? item.grossSale.toFixed(2) : '0.00'}</TableCell>
                  <TableCell>₹{typeof item.discountAmount === 'number' ? item.discountAmount.toFixed(2) : typeof item.discounts === 'number' ? item.discounts.toFixed(2) : '0.00'}</TableCell>
                  <TableCell>₹{typeof item.netSales === 'number' ? item.netSales.toFixed(2) : typeof item.netSale === 'number' ? item.netSale.toFixed(2) : '0.00'}</TableCell>
                  <TableCell>₹{typeof item.taxAmount === 'number' ? item.taxAmount.toFixed(2) : typeof item.tax === 'number' ? item.tax.toFixed(2) : '0.00'}</TableCell>
                  <TableCell>₹{typeof item.totalSales === 'number' ? item.totalSales.toFixed(2) : '0.00'}</TableCell>
                </TableRow>
              );
            })}
            {/* Total Row */}
            <TableRow className="font-bold bg-gray-50">
              <TableCell colSpan={4}>Total</TableCell>
              <TableCell>
                {paginatedProducts.filter((item: any) => item.status === 'delivered').reduce((sum: number, item: any) => sum + (item.quantitySold || item.unitsSold || 0), 0)}
              </TableCell>
              <TableCell>
                ₹{paginatedProducts.filter((item: any) => item.status === 'delivered').reduce((sum: number, item: any) => sum + (item.grossSales || item.grossSale || 0), 0).toFixed(2)}
              </TableCell>
              <TableCell>
                ₹{paginatedProducts.filter((item: any) => item.status === 'delivered').reduce((sum: number, item: any) => sum + (item.discountAmount || item.discounts || 0), 0).toFixed(2)}
              </TableCell>
              <TableCell>
                ₹{paginatedProducts.filter((item: any) => item.status === 'delivered').reduce((sum: number, item: any) => sum + (item.netSales || item.netSale || 0), 0).toFixed(2)}
              </TableCell>
              <TableCell>
                ₹{paginatedProducts.filter((item: any) => item.status === 'delivered').reduce((sum: number, item: any) => sum + (item.taxAmount || item.tax || 0), 0).toFixed(2)}
              </TableCell>
              <TableCell>
                ₹{paginatedProducts.filter((item: any) => item.status === 'delivered').reduce((sum: number, item: any) => sum + (item.totalSales || 0), 0).toFixed(2)}
              </TableCell>
            </TableRow>
          </TableBody>
        </Table>
      </div>
      <Pagination
        className="mt-4"
        currentPage={currentPage}
        totalPages={totalPages}
        onPageChange={setCurrentPage}
        itemsPerPage={itemsPerPage}
        onItemsPerPageChange={setItemsPerPage}
        totalItems={totalItems}
      />
    </div>
  );
};

// Component to display Category-wise Product report data in a table
const CategoryWiseProductTable = ({ product, category, brand, onFiltersChange, triggerRefresh }: any) => {
  const [filters, setFilters] = useState<FilterParams>({ product, category, brand, status: undefined });
  const [isFilterModalOpen, setIsFilterModalOpen] = useState(false);
  const [currentPage, setCurrentPage] = useState(1);
  const [itemsPerPage, setItemsPerPage] = useState(10); // 10 entries by default
  const [searchTerm, setSearchTerm] = useState('');
  const tableRef = useRef<HTMLDivElement>(null);

  // Use the RTK Query hook to fetch real data
  const { data, isLoading, isError, refetch } = useGetCategoryWiseProductReportQuery({
    product: product && product !== 'all' ? product : undefined,
    category: filters.category && filters.category !== 'all' ? filters.category : undefined,
    brand: brand && brand !== 'all' ? brand : undefined
  });

  const handleFilterChange = (newFilters: FilterParams) => {
    setFilters(newFilters);
    setCurrentPage(1); // Reset to first page when filters change

    // Notify parent component about filter changes
    if (onFiltersChange) {
      onFiltersChange(newFilters);
    }
  };

  // Export functions
  const handleExport = (format: string) => {
    switch (format) {
      case 'excel':
        exportToExcel(tableRef, 'category_wise_product_report');
        break;
      case 'csv':
        exportToCSV(tableRef, 'category_wise_product_report');
        break;
      case 'pdf':
        exportToPDF(tableRef, 'category_wise_product_report');
        break;
      case 'copy':
        copyToClipboard(tableRef);
        break;
      case 'print':
        printTable(tableRef);
        break;
      default:
        break;
    }
  };

  // Trigger refetch when filter values change or when explicitly triggered
  useEffect(() => {
    refetch();
  }, [refetch, product, category, brand, triggerRefresh]);

  // Extract categories from the API response
  const categories = data?.data?.categories || [];

  // Filter data based on search term
  const searchedCategories = useMemo(() => {
    if (!searchTerm) return categories;

    return categories.filter((category: any) =>
      Object.values(category).some(value =>
        value && value.toString().toLowerCase().includes(searchTerm.toLowerCase())
      )
    );
  }, [categories, searchTerm]);

  // Pagination logic
  const totalItems = searchedCategories.length;
  const totalPages = Math.ceil(totalItems / itemsPerPage);
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const paginatedCategories = searchedCategories.slice(startIndex, endIndex);

  if (isLoading) {
    return (
      <div>
        <div className="flex justify-between items-center mb-4 gap-2">
          <div className="relative w-64">
            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              type="search"
              placeholder="Search..."
              className="pl-8"
              value={searchTerm}
              onChange={(e) => {
                setSearchTerm(e.target.value);
                setCurrentPage(1); // Reset to first page when search term changes
              }}
            />
          </div>
          <div className="flex gap-2">
            <Button onClick={() => setIsFilterModalOpen(true)}>
              <Filter className="mr-2 h-4 w-4" />
              Filters
            </Button>
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button>
                  <Download className="mr-2 h-4 w-4" />
                  Export
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent align="end">
                <DropdownMenuItem onClick={() => handleExport('copy')}>
                  <Copy className="mr-2 h-4 w-4" />
                  Copy
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('excel')}>
                  <FileSpreadsheet className="mr-2 h-4 w-4" />
                  Excel
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('csv')}>
                  <FileText className="mr-2 h-4 w-4" />
                  CSV
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('pdf')}>
                  <FileText className="mr-2 h-4 w-4" />
                  PDF
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => handleExport('print')}>
                  <Printer className="mr-2 h-4 w-4" />
                  Print
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          </div>
        </div>
        <div className="rounded-md border">
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>Category Name</TableHead>
                <TableHead>Number of Products</TableHead>
                <TableHead>Active Products</TableHead>
                <TableHead>Average Price</TableHead>
                <TableHead>Average Sale Price</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {[...Array(5)].map((_, index) => (
                <TableRow key={index}>
                  <TableCell>
                    <Skeleton className="h-4 w-32" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-20" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-20" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-20" />
                  </TableCell>
                  <TableCell>
                    <Skeleton className="h-4 w-20" />
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </div>
      </div>
    );
  }

  if (isError) {
    return (
      <div>
        <div className="flex justify-between items-center mb-4 gap-2">
          <div className="relative w-64">
            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              type="search"
              placeholder="Search..."
              className="pl-8"
              value={searchTerm}
              onChange={(e) => {
                setSearchTerm(e.target.value);
                setCurrentPage(1); // Reset to first page when search term changes
              }}
            />
          </div>
          <Button onClick={() => setIsFilterModalOpen(true)}>
            <Filter className="mr-2 h-4 w-4" />
            Filters
          </Button>
        </div>
        <div className="text-center py-4 text-red-500">
          Failed to load category-wise product data. Please try again.
        </div>
      </div>
    );
  }

  if (paginatedCategories.length === 0) {
    return (
      <div>
        <div className="flex justify-between items-center mb-4 gap-2">
          <div className="relative w-64">
            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              type="search"
              placeholder="Search..."
              className="pl-8"
              value={searchTerm}
              onChange={(e) => {
                setSearchTerm(e.target.value);
                setCurrentPage(1); // Reset to first page when search term changes
              }}
            />
          </div>
          <Button onClick={() => setIsFilterModalOpen(true)}>
            <Filter className="mr-2 h-4 w-4" />
            Filters
          </Button>
        </div>
        <div className="text-center py-4 text-gray-500">
          No category data available.
        </div>
      </div>
    );
  }

  return (
    <div ref={tableRef}>
      <div className="flex justify-between items-center mb-4 gap-2">
        <div className="relative w-64">
          <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
          <Input
            type="search"
            placeholder="Search..."
            className="pl-8"
            value={searchTerm}
            onChange={(e) => {
              setSearchTerm(e.target.value);
              setCurrentPage(1); // Reset to first page when search term changes
            }}
          />
        </div>
        <div className="flex gap-2">
          <Button onClick={() => setIsFilterModalOpen(true)}>
            <Filter className="mr-2 h-4 w-4" />
            Filters
          </Button>
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button>
                <Download className="mr-2 h-4 w-4" />
                Export
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end">
              <DropdownMenuItem onClick={() => handleExport('copy')}>
                <Copy className="mr-2 h-4 w-4" />
                Copy
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('excel')}>
                <FileSpreadsheet className="mr-2 h-4 w-4" />
                Excel
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('csv')}>
                <FileText className="mr-2 h-4 w-4" />
                CSV
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('pdf')}>
                <FileText className="mr-2 h-4 w-4" />
                PDF
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => handleExport('print')}>
                <Printer className="mr-2 h-4 w-4" />
                Print
              </DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
        </div>
      </div>

      <FilterModal
        isOpen={isFilterModalOpen}
        onClose={() => setIsFilterModalOpen(false)}
        onApplyFilters={handleFilterChange}
        cities={[]}
        initialFilters={filters}
        showProductFilter={true}
        showCategoryFilter={true}
        showBrandFilter={true}
        hideBookingTypeFilter={true}
        hideClientFilter={true}
        hideServiceFilter={true}
        hideStaffFilter={true}
      />

      <div className="rounded-md border">
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead>Category Name</TableHead>
              <TableHead>Number of Products</TableHead>
              <TableHead>Active Products</TableHead>
              <TableHead>Average Price</TableHead>
              <TableHead>Average Sale Price</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {paginatedCategories.map((item: any, index: number) => {
              return (
                <TableRow key={index}>
                  <TableCell className="font-medium">{item.categoryName}</TableCell>
                  <TableCell>{item.numberOfProducts}</TableCell>
                  <TableCell>{item.activeProducts}</TableCell>
                  <TableCell>₹{typeof item.averagePrice === 'number' ? item.averagePrice.toFixed(2) : '0.00'}</TableCell>
                  <TableCell>₹{typeof item.averageSalePrice === 'number' ? item.averageSalePrice.toFixed(2) : '0.00'}</TableCell>
                </TableRow>
              );
            })}
          </TableBody>
        </Table>
      </div>
      <Pagination
        className="mt-4"
        currentPage={currentPage}
        totalPages={totalPages}
        onPageChange={setCurrentPage}
        itemsPerPage={itemsPerPage}
        onItemsPerPageChange={setItemsPerPage}
        totalItems={totalItems}
      />
    </div>
  );
};

export default function SupplierReports() {
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [isAllAppointmentsModalOpen, setIsAllAppointmentsModalOpen] = useState(false);
  const [isSummaryByServiceModalOpen, setIsSummaryByServiceModalOpen] = useState(false);
  const [isCompletedAppointmentsModalOpen, setIsCompletedAppointmentsModalOpen] = useState(false);
  const [isCancelledAppointmentsModalOpen, setIsCancelledAppointmentsModalOpen] = useState(false);
  const [isSettlementSummaryModalOpen, setIsSettlementSummaryModalOpen] = useState(false);
  const [selectedReport, setSelectedReport] = useState<Report | null>(null);
  const [region, setRegion] = useState('all');
  const [searchTerm, setSearchTerm] = useState('');
  const [isLoading, setIsLoading] = useState(true);

  // Refresh states for each appointment report
  const [allAppointmentsRefresh, setAllAppointmentsRefresh] = useState(0);
  const [salesByServiceRefresh, setSalesByServiceRefresh] = useState(0);
  const [salesByCustomerRefresh, setSalesByCustomerRefresh] = useState(0);
  const [productSummaryRefresh, setProductSummaryRefresh] = useState(0);
  const [salesByProductRefresh, setSalesByProductRefresh] = useState(0);
  const [summaryByServiceRefresh, setSummaryByServiceRefresh] = useState(0);
  const [completedAppointmentsRefresh, setCompletedAppointmentsRefresh] = useState(0);
  const [cancelledAppointmentsRefresh, setCancelledAppointmentsRefresh] = useState(0);
  const [settlementSummaryRefresh, setSettlementSummaryRefresh] = useState(0);

  // Modal states for each report
  const [isSalesByServiceModalOpen, setIsSalesByServiceModalOpen] = useState(false);
  const [isSalesByCustomerModalOpen, setIsSalesByCustomerModalOpen] = useState(false);
  const [isProductSummaryModalOpen, setIsProductSummaryModalOpen] = useState(false);
  const [isSalesByProductModalOpen, setIsSalesByProductModalOpen] = useState(false);

  // Date filter states for each appointment report
  const [allAppointmentsFilter, setAllAppointmentsFilter] = useState({
    startDate: '',
    endDate: '',
    client: '',
    service: '',
    staff: '',
    status: '',
    bookingType: ''
  });

  const [salesByServiceFilter, setSalesByServiceFilter] = useState({
    startDate: '',
    endDate: '',
    client: '',
    service: '',
    staff: '',
    status: '',
    bookingType: ''
  });

  const [summaryByServiceFilter, setSummaryByServiceFilter] = useState({
    startDate: '',
    endDate: '',
    client: '',
    service: '',
    staff: '',
    status: '',
    bookingType: ''
  });

  const [completedAppointmentsFilter, setCompletedAppointmentsFilter] = useState({
    startDate: '',
    endDate: '',
    client: '',
    service: '',
    staff: '',
    bookingType: ''
  });

  const [cancelledAppointmentsFilter, setCancelledAppointmentsFilter] = useState({
    startDate: '',
    endDate: '',
    client: '',
    service: '',
    staff: '',
    status: '',
    bookingType: ''
  });

  const [salesByCustomerFilter, setSalesByCustomerFilter] = useState({
    startDate: '',
    endDate: '',
    client: '',
    service: '',
    staff: '',
    status: '',
    bookingType: ''
  });

  const [productSummaryFilter, setProductSummaryFilter] = useState({
    product: '',
    category: '',
    brand: '',
    status: '',
    isActive: '',
    region: ''
  });

  const [salesByProductFilter, setSalesByProductFilter] = useState({
    product: '',
    category: '',
    brand: '',
    status: '',
    isActive: ''
  });

  const [settlementSummaryFilter, setSettlementSummaryFilter] = useState({
    settlementFromDate: undefined,
    settlementToDate: undefined,
    startDate: undefined,
    endDate: undefined,
    client: undefined,
    service: undefined,
    staff: undefined,
    status: undefined,
    bookingType: undefined
  });

  // Simulate loading for 1.5 seconds
  useEffect(() => {
    const timer = setTimeout(() => {
      setIsLoading(false);
    }, 1500);
    return () => clearTimeout(timer);
  }, []);

  const handleViewClick = (report: Report) => {
    setSelectedReport(report);

    // Handle appointment reports specially
    if (report.title === "All Appointments Report") {
      setIsAllAppointmentsModalOpen(true);
    } else if (report.title === "Appointment Summary by Service") {
      setIsSummaryByServiceModalOpen(true);
    } else if (report.title === "Completed Appointments Report") {
      setIsCompletedAppointmentsModalOpen(true);
    } else if (report.title === "Cancelled Appointments Report") {
      setIsCancelledAppointmentsModalOpen(true);
    } else if (report.title === "Sales by Service") {
      setIsSalesByServiceModalOpen(true); // Using the specific modal for this report
    } else if (report.title === "Sales by Customer") {
      setIsSalesByCustomerModalOpen(true); // Using the specific modal for this report
    } else if (report.title === "Sales by Product") {
      setIsSalesByProductModalOpen(true); // Using the specific modal for this report
    } else if (report.title === "All Products Report" || report.title === "Inventory / Stock Report" || report.title === "Category-wise Product Report") {
      setIsProductSummaryModalOpen(true); // Using the specific modal for product reports
    } else if (report.title === "All Appointments by Staff") {
      setIsModalOpen(true); // Using the same modal for this new report
    } else if (report.title === "Settlement Summary Report") {
      setIsSettlementSummaryModalOpen(true); // Using the specific modal for this report
    } else {
      setIsModalOpen(true);
    }
  };

  const filteredReportsData = useMemo(() => {
    if (!searchTerm) return reportsData;

    return reportsData
      .map(category => ({
        ...category,
        reports: category.reports.filter(report =>
          report.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
          report.description.toLowerCase().includes(searchTerm.toLowerCase())
        ),
      }))
      .filter(category => category.reports.length > 0);
  }, [searchTerm]);

  if (isLoading) {
    return (
      <div className="p-4 sm:p-6 lg:p-8 space-y-6">
        <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <Skeleton className="h-8 w-64" />
            <Skeleton className="h-4 w-96 mt-2" />
          </div>
          <div className="relative">
            <Skeleton className="h-10 w-80" />
          </div>
        </div>
        <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
          {[...Array(4)].map((_, i) => (
            <Card key={i}>
              <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                <Skeleton className="h-4 w-24" />
                <Skeleton className="h-4 w-4" />
              </CardHeader>
              <CardContent>
                <Skeleton className="h-8 w-20 mb-2" />
                <Skeleton className="h-3 w-32" />
              </CardContent>
            </Card>
          ))}
        </div>
        <div className="space-y-8">
          {[...Array(3)].map((_, categoryIndex) => (
            <div key={categoryIndex}>
              <Skeleton className="h-7 w-48 mb-4" />
              <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                {[...Array(3)].map((_, reportIndex) => (
                  <Card key={reportIndex}>
                    <CardHeader>
                      <Skeleton className="h-6 w-40 mb-2" />
                      <Skeleton className="h-4 w-full mb-1" />
                      <Skeleton className="h-4 w-3/4" />
                    </CardHeader>
                    <CardFooter className="pt-0">
                      <div className="flex gap-2 w-full">
                        <Skeleton className="h-10 flex-1" />
                        <Skeleton className="h-10 flex-1" />
                      </div>
                    </CardFooter>
                  </Card>
                ))}
              </div>
            </div>
          ))}
        </div>
      </div>
    );
  }

  return (
    <div className="p-4 sm:p-6 lg:p-8">
      <div className="flex flex-col md:flex-row md:items-center md:justify-between mb-8">
        <div>
          <h1 className="text-3xl font-bold font-headline mb-2">Reports</h1>
          <p className="text-lg text-muted-foreground">
            Generate and download detailed reports for various components of the platform.
          </p>
        </div>
        <div className="relative mt-4 md:mt-0">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
          <Input
            type="search"
            placeholder="Search reports..."
            className="w-full md:w-80 pl-10"
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
          />
        </div>
      </div>


      <div className="space-y-10">
        {filteredReportsData
          .filter(category =>
            category.category !== "Marketing & Engagement Reports" &&
            category.category !== "User & Vendor Reports" &&
            category.category !== "Financial Reports"
          )
          .length > 0 ?
          filteredReportsData
            .filter(category =>
              category.category !== "Marketing & Engagement Reports" &&
              category.category !== "User & Vendor Reports" &&
              category.category !== "Financial Reports"
            )
            .map((category) => (
              <div key={category.category}>
                <h2 className="text-xl font-semibold font-headline mb-4 pb-2 border-b">{category.category}</h2>
                <div className="grid gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
                  {category.reports.map((report, index) => (
                    <Card key={index} className="flex flex-col">
                      <CardHeader>
                        <CardTitle>{report.title}</CardTitle>
                        <CardDescription>{report.description}</CardDescription>
                      </CardHeader>
                      <CardContent className="flex-grow">
                        <p className="text-sm text-muted-foreground">{report.details}</p>
                      </CardContent>
                      <CardFooter className="flex justify-end gap-2">
                        <Button
                        variant="outline" size="sm" onClick={() => handleViewClick(report)}>
                          <Eye className="mr-2 h-4 w-4" />
                          View
                        </Button>
                        <Button size="sm" 
                        className='h-12 px-6 rounded-lg'
                        >
                          <Download className="mr-2 h-4 w-4" />
                          Download
                        </Button>
                      </CardFooter>
                    </Card>
                  ))}
                </div>
              </div>
            )) : (
            <div className="text-center py-16 text-muted-foreground">
              <p>No reports found matching your search.</p>
            </div>
          )}
      </div>

      {/* Generic Report Modal */}
      <Dialog open={isModalOpen} onOpenChange={setIsModalOpen}>
        <DialogContent className="sm:max-w-2xl">
          <DialogHeader>
            <DialogTitle>{selectedReport?.title}</DialogTitle>
            <DialogDescription>
              A preview of the "{selectedReport?.title}".
            </DialogDescription>
          </DialogHeader>
          <DialogFooter>
            <Button variant="secondary" onClick={() => setIsModalOpen(false)}>
              Close
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* All Appointments Report Modal */}
      <Dialog open={isAllAppointmentsModalOpen} onOpenChange={setIsAllAppointmentsModalOpen}>
        <DialogContent className="sm:max-w-4xl max-h-[80vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>All Appointments</DialogTitle>
            <DialogDescription>
              Complete record of all appointments with detailed information.
            </DialogDescription>
          </DialogHeader>
          <div className="py-4">
            <AllAppointmentsTable
              startDate={allAppointmentsFilter.startDate || undefined}
              endDate={allAppointmentsFilter.endDate || undefined}
              client={allAppointmentsFilter.client || undefined}
              service={allAppointmentsFilter.service || undefined}
              staff={allAppointmentsFilter.staff || undefined}
              status={allAppointmentsFilter.status || undefined}
              bookingType={allAppointmentsFilter.bookingType || undefined}
              triggerRefresh={allAppointmentsRefresh}
              onFiltersChange={(filters: any) => {
                // Update filter state when table filters change
                setAllAppointmentsFilter(prev => ({
                  ...prev,
                  ...filters
                }));
              }}
            />
          </div>
          <DialogFooter>
            <Button variant="secondary" onClick={() => setIsAllAppointmentsModalOpen(false)}>
              Close
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Summary by Service Report Modal */}
      <Dialog open={isSummaryByServiceModalOpen} onOpenChange={setIsSummaryByServiceModalOpen}>
        <DialogContent className="sm:max-w-3xl max-h-[80vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>Appointment Summary by Service</DialogTitle>
            <DialogDescription>
              Aggregated view showing appointment counts, revenue, and popularity by service type.
            </DialogDescription>
          </DialogHeader>
          <div className="py-4">
            <SummaryByServiceTable
              startDate={summaryByServiceFilter.startDate ? new Date(summaryByServiceFilter.startDate) : undefined}
              endDate={summaryByServiceFilter.endDate ? new Date(summaryByServiceFilter.endDate) : undefined}
              client={summaryByServiceFilter.client || undefined}
              service={summaryByServiceFilter.service || undefined}
              staff={summaryByServiceFilter.staff || undefined}
              status={summaryByServiceFilter.status || undefined}
              bookingType={summaryByServiceFilter.bookingType || undefined}
              triggerRefresh={summaryByServiceRefresh}
              onFiltersChange={(filters: any) => {
                // Update filter state when table filters change
                setSummaryByServiceFilter(prev => ({
                  ...prev,
                  ...filters
                }));
              }}
            />
          </div>
          <DialogFooter>
            <Button variant="secondary" onClick={() => setIsSummaryByServiceModalOpen(false)}>
              Close
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Completed Appointments Report Modal */}
      <Dialog open={isCompletedAppointmentsModalOpen} onOpenChange={setIsCompletedAppointmentsModalOpen}>
        <DialogContent className="sm:max-w-4xl max-h-[80vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>Completed Appointments Report</DialogTitle>
            <DialogDescription>
              Detailed listing of all successfully completed appointments.
            </DialogDescription>
          </DialogHeader>
          <div className="py-4">
            <CompletedAppointmentsTable
              startDate={completedAppointmentsFilter.startDate ? new Date(completedAppointmentsFilter.startDate) : undefined}
              endDate={completedAppointmentsFilter.endDate ? new Date(completedAppointmentsFilter.endDate) : undefined}
              client={completedAppointmentsFilter.client || undefined}
              service={completedAppointmentsFilter.service || undefined}
              staff={completedAppointmentsFilter.staff || undefined}
              bookingType={completedAppointmentsFilter.bookingType || undefined}
              triggerRefresh={completedAppointmentsRefresh}
              onFiltersChange={(filters: any) => {
                // Update filter state when table filters change
                setCompletedAppointmentsFilter(prev => ({
                  ...prev,
                  ...filters
                }));
              }}
            />
          </div>
          <DialogFooter>
            <Button variant="secondary" onClick={() => setIsCompletedAppointmentsModalOpen(false)}>
              Close
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Cancelled Appointments Report Modal */}
      <Dialog open={isCancelledAppointmentsModalOpen} onOpenChange={setIsCancelledAppointmentsModalOpen}>
        <DialogContent className="sm:max-w-4xl max-h-[80vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>Cancelled Appointments Report</DialogTitle>
            <DialogDescription>
              Comprehensive analysis of cancelled appointments with reasons and impact.
            </DialogDescription>
          </DialogHeader>
          <div className="py-4">
            <CancelledAppointmentsTable
              startDate={cancelledAppointmentsFilter.startDate ? new Date(cancelledAppointmentsFilter.startDate) : undefined}
              endDate={cancelledAppointmentsFilter.endDate ? new Date(cancelledAppointmentsFilter.endDate) : undefined}
              client={cancelledAppointmentsFilter.client || undefined}
              service={cancelledAppointmentsFilter.service || undefined}
              staff={cancelledAppointmentsFilter.staff || undefined}
              status={cancelledAppointmentsFilter.status || undefined}
              bookingType={cancelledAppointmentsFilter.bookingType || undefined}
              triggerRefresh={cancelledAppointmentsRefresh}
              onFiltersChange={(filters: any) => {
                // Update filter state when table filters change
                setCancelledAppointmentsFilter(prev => ({
                  ...prev,
                  ...filters
                }));
              }}
            />
          </div>
          <DialogFooter>
            <Button variant="secondary" onClick={() => setIsCancelledAppointmentsModalOpen(false)}>
              Close
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Sales by Service Report Modal */}
      <Dialog open={isSalesByServiceModalOpen} onOpenChange={setIsSalesByServiceModalOpen}>
        <DialogContent className="sm:max-w-4xl max-h-[80vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>Sales by Service</DialogTitle>
            <DialogDescription>
              Detailed report showing revenue generated by each service type (only completed appointments).
            </DialogDescription>
          </DialogHeader>
          <div className="py-4">
            <SalesByServiceTable
              startDate={salesByServiceFilter.startDate ? new Date(salesByServiceFilter.startDate) : undefined}
              endDate={salesByServiceFilter.endDate ? new Date(salesByServiceFilter.endDate) : undefined}
              client={salesByServiceFilter.client || undefined}
              service={salesByServiceFilter.service || undefined}
              staff={salesByServiceFilter.staff || undefined}
              // Status is fixed to 'completed' in the backend for sales reports
              bookingType={salesByServiceFilter.bookingType || undefined}
              triggerRefresh={salesByServiceRefresh}
              onFiltersChange={(filters: any) => {
                // Update filter state when table filters change
                setSalesByServiceFilter(prev => ({
                  ...prev,
                  ...filters
                }));
              }}
            />
          </div>
          <DialogFooter>
            <Button variant="secondary" onClick={() => setIsSalesByServiceModalOpen(false)}>
              Close
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Sales by Customer Report Modal */}
      <Dialog open={isSalesByCustomerModalOpen} onOpenChange={setIsSalesByCustomerModalOpen}>
        <DialogContent className="sm:max-w-4xl max-h-[80vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>Sales by Customer</DialogTitle>
            <DialogDescription>
              Analysis of revenue generated by individual customers.
            </DialogDescription>
          </DialogHeader>
          <div className="py-4">
            <SalesByCustomerTable
              startDate={salesByCustomerFilter.startDate ? new Date(salesByCustomerFilter.startDate) : undefined}
              endDate={salesByCustomerFilter.endDate ? new Date(salesByCustomerFilter.endDate) : undefined}
              client={salesByCustomerFilter.client || undefined}
              service={salesByCustomerFilter.service || undefined}
              staff={salesByCustomerFilter.staff || undefined}
              // Status is fixed to 'completed' in the backend for sales reports
              bookingType={salesByCustomerFilter.bookingType || undefined}
              triggerRefresh={salesByCustomerRefresh}
              onFiltersChange={(filters: any) => {
                // Update filter state when table filters change
                setSalesByCustomerFilter(prev => ({
                  ...prev,
                  ...filters
                }));
              }}
            />
          </div>
          <DialogFooter>
            <Button variant="secondary" onClick={() => setIsSalesByCustomerModalOpen(false)}>
              Close
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Product Summary Report Modal */}
      <Dialog open={isProductSummaryModalOpen} onOpenChange={setIsProductSummaryModalOpen}>
        <DialogContent className="sm:max-w-4xl max-h-[80vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>{selectedReport?.title}</DialogTitle>
            <DialogDescription>
              {selectedReport?.title === "All Products Report" && "Complete record of all products with detailed information."}
              {selectedReport?.title === "Inventory / Stock Report" && "Detailed analysis of product inventory and stock levels."}
              {selectedReport?.title === "Category-wise Product Report" && "Aggregated view showing product counts and sales by category."}
            </DialogDescription>
          </DialogHeader>
          <div className="py-4">
            {selectedReport?.title === "Inventory / Stock Report" ? (
              <InventoryStockTable
                product={productSummaryFilter.product || undefined}
                category={productSummaryFilter.category || undefined}
                brand={productSummaryFilter.brand || undefined}
                triggerRefresh={productSummaryRefresh}
                onFiltersChange={(filters: any) => {
                  // Update filter state when table filters change
                  setProductSummaryFilter(prev => ({
                    ...prev,
                    ...filters
                  }));
                }}
              />
            ) : selectedReport?.title === "Category-wise Product Report" ? (
              <CategoryWiseProductTable
                product={productSummaryFilter.product || undefined}
                category={productSummaryFilter.category || undefined}
                brand={productSummaryFilter.brand || undefined}
                triggerRefresh={productSummaryRefresh}
                onFiltersChange={(filters: any) => {
                  // Update filter state when table filters change
                  setProductSummaryFilter(prev => ({
                    ...prev,
                    ...filters
                  }));
                }}
              />
            ) : (
              <ProductSummaryTable
                product={productSummaryFilter.product || undefined}
                category={productSummaryFilter.category || undefined}
                brand={productSummaryFilter.brand || undefined}
                status={productSummaryFilter.status || undefined}
                isActive={productSummaryFilter.isActive !== undefined ? productSummaryFilter.isActive : undefined}
                triggerRefresh={productSummaryRefresh}
                onFiltersChange={(filters: any) => {
                  // Update filter state when table filters change
                  setProductSummaryFilter(prev => ({
                    ...prev,
                    ...filters
                  }));
                }}
              />
            )}
          </div>
          <DialogFooter>
            <Button variant="secondary" onClick={() => setIsProductSummaryModalOpen(false)}>
              Close
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Sales by Product Report Modal */}
      <Dialog open={isSalesByProductModalOpen} onOpenChange={setIsSalesByProductModalOpen}>
        <DialogContent className="sm:max-w-4xl max-h-[80vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>Sales by Product Report</DialogTitle>
            <DialogDescription>
              Detailed report showing revenue generated by each product type (only completed orders).
            </DialogDescription>
          </DialogHeader>
          <div className="py-4">
            <SalesByProductTable
              product={salesByProductFilter.product || undefined}
              category={salesByProductFilter.category || undefined}
              brand={salesByProductFilter.brand || undefined}
              status={salesByProductFilter.status || undefined}
              isActive={salesByProductFilter.isActive !== undefined ? salesByProductFilter.isActive : undefined}
              triggerRefresh={salesByProductRefresh}
              onFiltersChange={(filters: any) => {
                // Update filter state when table filters change
                setSalesByProductFilter(prev => ({
                  ...prev,
                  ...filters
                }));
              }}
            />
          </div>
          <DialogFooter>
            <Button variant="secondary" onClick={() => setIsSalesByProductModalOpen(false)}>
              Close
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
      {/* All Appointments by Staff Report Modal */}
      <Dialog open={isModalOpen && selectedReport?.title === "All Appointments by Staff"} onOpenChange={(open) => {
        if (!open) setIsModalOpen(false);
      }}>
        <DialogContent className="sm:max-w-4xl max-h-[80vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>All Appointments by Staff</DialogTitle>
            <DialogDescription>
              Detailed report showing appointment statistics aggregated by staff member.
            </DialogDescription>
          </DialogHeader>
          <div className="py-4">
            <AllAppointmentsByStaffTable
              startDate={allAppointmentsFilter.startDate ? new Date(allAppointmentsFilter.startDate) : undefined}
              endDate={allAppointmentsFilter.endDate ? new Date(allAppointmentsFilter.endDate) : undefined}
              client={allAppointmentsFilter.client || undefined}
              service={allAppointmentsFilter.service || undefined}
              staff={allAppointmentsFilter.staff || undefined}
              status={allAppointmentsFilter.status || undefined}
              bookingType={allAppointmentsFilter.bookingType || undefined}
              triggerRefresh={allAppointmentsRefresh}
              onFiltersChange={(filters: any) => {
                // Update filter state when table filters change
                setAllAppointmentsFilter(prev => ({
                  ...prev,
                  ...filters
                }));
              }}
            />
          </div>
          <DialogFooter>
            <Button variant="secondary" onClick={() => setIsModalOpen(false)}>
              Close
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}    
